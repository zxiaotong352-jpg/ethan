<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>4周减脂打卡｜训练+饮食+食谱+购物清单</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#121a27; --muted:#9bb0c8; --text:#e9f0fb;
      --accent:#4ea1ff; --ok:#21c47b; --warn:#ffb020; --danger:#ff4d4d;
      --line:rgba(255,255,255,.10);
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC","Microsoft YaHei", sans-serif;
      background:var(--bg); color:var(--text); }
    .wrap{ max-width:1200px; margin:0 auto; padding:16px; }
    h1{ margin:0 0 8px; font-size:20px; }
    .muted{ color:var(--muted); font-size:13px; line-height:1.5; }
    .nav{ display:flex; gap:8px; flex-wrap:wrap; margin:12px 0 14px; }
    .tab{
      border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);
      padding:8px 10px; border-radius:999px; cursor:pointer; font-size:13px;
    }
    .tab.active{ border-color: rgba(78,161,255,.55); background: rgba(78,161,255,.16); }
    .grid{ display:grid; grid-template-columns: 1.2fr 1fr; gap:12px; }
    @media(max-width:980px){ .grid{ grid-template-columns:1fr; } }
    .card{
      background:var(--card); border:1px solid rgba(255,255,255,.07); border-radius:14px;
      padding:14px; box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    h2{ margin:0 0 10px; font-size:16px; color:#dbe7fb; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    label{ font-size:12px; color:var(--muted); }
    input, select, button, textarea{
      background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);
      color: var(--text); border-radius:10px; padding:8px 10px; outline:none;
      font-family: inherit;
    }
    input[type="date"]{ padding:7px 10px; }
    button{ cursor:pointer; }
    button.primary{ background: rgba(78,161,255,.18); border-color: rgba(78,161,255,.45); }
    button.ok{ background: rgba(33,196,123,.18); border-color: rgba(33,196,123,.45); }
    button.warn{ background: rgba(255,176,32,.16); border-color: rgba(255,176,32,.40); }
    button.danger{ background: rgba(255,77,77,.14); border-color: rgba(255,77,77,.35); }
    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px;
      border-radius:999px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04);
      font-size:13px;
    }
    .pill strong{ font-size:14px; }
    .hr{ height:1px; background: rgba(255,255,255,.08); margin:12px 0; }
    .scroll{ max-height: 560px; overflow:auto; border-radius: 12px; border:1px solid rgba(255,255,255,.08); }
    table{ width:100%; border-collapse: collapse; }
    th,td{ border-bottom:1px solid rgba(255,255,255,.08); padding:8px 8px; vertical-align: top; }
    th{ text-align:left; font-size:12px; color:var(--muted); background: rgba(255,255,255,.03); position: sticky; top: 0; }
    .chk{ display:flex; align-items:center; gap:8px; margin:4px 0; }
    .chk input{ transform: scale(1.1); }
    .small{ font-size:12px; color:var(--muted); }
    .tag{ font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.12); display:inline-block; }
    .tag.a{ border-color: rgba(78,161,255,.45); color: #bfe0ff; }
    .tag.b{ border-color: rgba(33,196,123,.45); color: #bff6dc; }
    .tag.c{ border-color: rgba(255,176,32,.45); color: #ffe1a8; }
    .split{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media(max-width:680px){ .split{ grid-template-columns:1fr; } }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .hint{ padding:10px; border:1px dashed rgba(255,255,255,.18); border-radius:12px; background: rgba(255,255,255,.03); }
    canvas{ width:100%; height:260px; background: rgba(255,255,255,.02); border:1px solid rgba(255,255,255,.10); border-radius:12px; }
  
    .calGrid{ display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; }
    .calCell{
      border:1px solid rgba(255,255,255,.10); border-radius:12px; padding:10px;
      background: rgba(255,255,255,.03); cursor:pointer; min-height:72px;
      display:flex; flex-direction:column; justify-content:space-between;
    }
    .calCell:hover{ border-color: rgba(78,161,255,.55); }
    .calTop{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .calDate{ font-size:12px; color: var(--muted); }
    .calDow{ font-size:12px; color: var(--muted); }
    .calBadge{ font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.12); }
    .calDone{ background: rgba(33,196,123,.16); border-color: rgba(33,196,123,.45); color:#bff6dc; }
    .calMiss{ background: rgba(255,77,77,.10); border-color: rgba(255,77,77,.35); color:#ffd0d0; }
    .calTodo{ background: rgba(255,176,32,.12); border-color: rgba(255,176,32,.40); color:#ffe1a8; }
    .calToday{ outline:2px solid rgba(78,161,255,.55); outline-offset:2px; }
    .twoCol{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media(max-width:680px){ .twoCol{ grid-template-columns:1fr; } }

  
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px; z-index:9999;
      background:rgba(0,0,0,.75); color:#fff;
      padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      font-size:13px; max-width:92vw;
      box-shadow:0 12px 30px rgba(0,0,0,.35);
      opacity:0; pointer-events:none; transition:opacity .2s ease;
    }
    .toast.show{ opacity:1; }
  
/* ===== UI 优化（不影响功能） ===== */
:root{
  --radius:18px;
  --radius2:14px;
  --shadow: 0 14px 40px rgba(0,0,0,.35);
  --shadow2: 0 10px 24px rgba(0,0,0,.28);
  --glass: rgba(18,26,39,.62);
}
body{
  background:
    radial-gradient(1100px 600px at 15% -10%, rgba(78,161,255,.22), transparent 60%),
    radial-gradient(900px 520px at 90% 0%, rgba(33,196,123,.16), transparent 55%),
    radial-gradient(900px 520px at 70% 120%, rgba(255,176,32,.12), transparent 60%),
    var(--bg);
}
.wrap{ padding:18px; }
.hero{
  padding:14px 14px 10px;
  border-radius: var(--radius);
  background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.10);
  box-shadow: var(--shadow2);
  margin-bottom:12px;
}
.heroRow{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap; }
.hero h1{ margin:0; font-size:22px; letter-spacing:.2px; }
.hero .muted{ margin-top:6px; font-size:13px; }
.heroMeta{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
.badge{
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 10px; border-radius:999px;
  background: rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.10);
  font-size:12px; color:var(--muted);
}
.badge strong{ color:var(--text); font-weight:650; }

/* 顶部导航更像“分段控件”，并支持吸顶 */
.nav{
  position: sticky;
  top: 10px;
  z-index: 50;
  padding:10px;
  border-radius: var(--radius);
  background: var(--glass);
  backdrop-filter: blur(10px);
  border:1px solid rgba(255,255,255,.10);
  box-shadow: var(--shadow2);
}
.tab{
  padding:10px 12px;
  border-radius: 999px;
  transition: transform .08s ease, border-color .15s ease, background .15s ease;
  user-select:none;
}
.tab:active{ transform: scale(.98); }
.tab.active{
  background: rgba(78,161,255,.18);
  border-color: rgba(78,161,255,.55);
  box-shadow: 0 6px 18px rgba(78,161,255,.10);
}

/* 卡片与排版 */
.card{
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding:16px;
}
h2{ font-size:16px; margin:0 0 10px; letter-spacing:.2px; }
.hr{ background:rgba(255,255,255,.10); }
.grid{ gap:14px; }

/* 输入与按钮更统一 */
input, select, textarea{
  border-radius: var(--radius2) !important;
  border-color: rgba(255,255,255,.14) !important;
  background: rgba(255,255,255,.04) !important;
}
input:focus, select:focus, textarea:focus{
  outline: none;
  border-color: rgba(78,161,255,.60) !important;
  box-shadow: 0 0 0 3px rgba(78,161,255,.16);
}
button{
  border-radius: var(--radius2);
  padding:10px 12px;
  transition: transform .08s ease, border-color .15s ease, background .15s ease;
}
button:active{ transform: scale(.99); }

/* 表格更清晰 */
table{
  border-radius: var(--radius);
  overflow:hidden;
}
thead th{
  background: rgba(255,255,255,.06);
}
tbody tr:hover{
  background: rgba(255,255,255,.03);
}

/* 面板切换时更舒服（轻微） */
.panel{ animation: fadein .14s ease; }
@keyframes fadein{
  from{ opacity:.75; transform: translateY(2px); }
  to{ opacity:1; transform: translateY(0); }
}

/* 更好的触控 */
.chk input{ transform: scale(1.05); }

/* 让 toast 更像系统提示 */
.toast{
  border-radius: 999px;
  padding:10px 14px;
}


/* ===== 全页面增强（所有页面） ===== */
.panel .card h2{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
.panel .card h2::after{
  content:""; flex:1; height:1px;
  background: linear-gradient(90deg, rgba(255,255,255,.12), rgba(255,255,255,0));
  opacity:.55;
  margin-left:10px;
}
.small{ font-size:12px; line-height:1.5; color: rgba(233,240,251,.85); }
.scroll{ border-radius: var(--radius); }

/* 今日行高亮（每日打卡表） */
.todayRow{
  background: linear-gradient(90deg, rgba(78,161,255,.12), rgba(33,196,123,.06));
  position:relative;
}
.todayRow td:first-child{ font-weight:800; }
.todayRow::after{
  content:"今天";
  position:absolute; right:10px; top:6px;
  font-size:11px; color:rgba(233,240,251,.85);
  padding:2px 8px; border-radius:999px;
  background:rgba(78,161,255,.18);
  border:1px solid rgba(78,161,255,.35);
}

/* 底部快捷栏（像 App） */
.bottomBar{
  position:fixed;
  left:12px; right:12px;
  bottom: max(12px, env(safe-area-inset-bottom));
  z-index: 60;
  border-radius: 22px;
  background: rgba(18,26,39,.70);
  backdrop-filter: blur(12px);
  border:1px solid rgba(255,255,255,.12);
  box-shadow: 0 16px 50px rgba(0,0,0,.45);
  padding:10px 10px 8px;
}
.bbRow{ display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
.bbNav{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.bbQuick{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }

.bbBtn{
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  color: rgba(233,240,251,.88);
  padding:9px 10px;
  border-radius: 16px;
  font-size:12px;
  display:inline-flex; gap:6px; align-items:center;
  cursor:pointer;
  user-select:none;
}
.bbBtn:hover{ border-color: rgba(78,161,255,.45); }
.bbBtn:active{ transform: scale(.99); }
.bbBtn.active{
  background: rgba(78,161,255,.18);
  border-color: rgba(78,161,255,.55);
}
.bbBtn.on{
  background: rgba(33,196,123,.14);
  border-color: rgba(33,196,123,.50);
}
.bbBtn.warnOn{
  background: rgba(255,176,32,.14);
  border-color: rgba(255,176,32,.50);
}

.bbLabel{ opacity:.9; }
.bbDot{
  width:8px; height:8px; border-radius:50%;
  background: rgba(255,255,255,.25);
}
.bbBtn.on .bbDot{ background: rgba(33,196,123,.95); }
.bbBtn.warnOn .bbDot{ background: rgba(255,176,32,.95); }

/* 给页面内容留出底部空间，防止被底栏遮住 */
body{ padding-bottom: 110px; }
@media(min-width:900px){ body{ padding-bottom: 96px; } }

/* 让按钮更像 iOS */
button.primary, .bbBtn.primary{
  background: rgba(78,161,255,.20);
  border-color: rgba(78,161,255,.55);
}
button.ok, .bbBtn.ok{
  background: rgba(33,196,123,.16);
  border-color: rgba(33,196,123,.55);
}


/* ===== iOS 风格再强化（全部页面） ===== */

/* 底部栏：图标+短字，更像原生 TabBar */
.bbNav .bbBtn, .bbQuick .bbBtn{
  padding:10px 12px;
  border-radius: 18px;
}
.bbIcon{ font-size:15px; line-height:1; }
.bbLabel{ font-size:11px; letter-spacing:.2px; }
.bbBtn{ gap:8px; }
.bbBtn .bbDot{ display:none; } /* 用高亮代替小圆点 */
.bbNav .bbBtn{ min-width:72px; justify-content:center; }
.bbQuick .bbBtn{ min-width:86px; justify-content:center; }
@media(max-width:420px){
  .bbNav .bbBtn{ min-width:64px; padding:9px 10px; }
  .bbQuick .bbBtn{ min-width:78px; padding:9px 10px; }
}

/* 今日看板 */
.todayBoard{
  background:
    radial-gradient(800px 320px at 20% -10%, rgba(78,161,255,.24), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.12);
}
.tbTop{ display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:flex-start; }
.tbTitle{ font-size:16px; font-weight:800; letter-spacing:.2px; margin:0; }
.tbSub{ color:rgba(233,240,251,.78); font-size:12px; margin-top:6px; }
.tbPills{ display:flex; gap:8px; flex-wrap:wrap; }
.tbPill{
  display:inline-flex; align-items:center; gap:8px;
  padding:8px 10px; border-radius:999px;
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.12);
  font-size:12px;
}
.tbPill strong{ font-weight:800; }
.tbGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:12px; }
@media(max-width:880px){ .tbGrid{ grid-template-columns:1fr; } }
.tbBox{
  border-radius: var(--radius);
  background: rgba(0,0,0,.14);
  border:1px solid rgba(255,255,255,.10);
  padding:12px;
}
.tbActions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
.tbMiniBtn{
  display:inline-flex; align-items:center; justify-content:center; gap:6px;
  padding:10px 12px; border-radius: 16px; font-size:12px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  cursor:pointer;
  user-select:none;
}
.tbMiniBtn.on{ background: rgba(33,196,123,.16); border-color: rgba(33,196,123,.55); }
.tbMiniBtn.warnOn{ background: rgba(255,176,32,.14); border-color: rgba(255,176,32,.55); }
.progressBar{
  height:10px; border-radius:999px;
  background: rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.10);
  overflow:hidden;
}
.progressBar > div{
  height:100%;
  background: linear-gradient(90deg, rgba(78,161,255,.90), rgba(33,196,123,.90));
  width:0%;
}

/* 日历更像 Apple Calendar：更紧凑 + 顶部周标题 */
.calWeekHead{
  display:grid; grid-template-columns: repeat(7, 1fr);
  gap:8px; margin-bottom:8px;
}
.calWeekHead div{
  font-size:11px; color: rgba(233,240,251,.75);
  text-align:center; padding:6px 0;
  border-radius: 12px;
  background: rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.08);
}
.calCell{
  min-height:64px;
  padding:10px;
  border-radius: 18px;
}
.calDate{ font-size:11px; }
.calBadge{ font-size:11px; padding:2px 8px; }
.calCell .row{ gap:6px; }
.taskTiny{
  height:6px; border-radius: 999px;
  background: rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.10);
  overflow:hidden;
  margin-top:6px;
}
.taskTiny > div{
  height:100%;
  background: rgba(78,161,255,.85);
  width:0%;
}
/* 用颜色区分状态更明显 */
.calDone{ background: rgba(33,196,123,.11); }
.calTodo{ background: rgba(255,176,32,.09); }
.calMiss{ background: rgba(255,77,77,.07); }

/* 图表：响应式 + tooltip */
.chartWrap{ position:relative; }
.chartTip{
  position:absolute; pointer-events:none; z-index:5;
  transform: translate(-50%, -110%);
  background: rgba(0,0,0,.78);
  border:1px solid rgba(255,255,255,.16);
  border-radius: 14px;
  padding:8px 10px;
  font-size:12px;
  color: rgba(255,255,255,.92);
  white-space: nowrap;
  opacity:0;
  transition: opacity .08s ease;
}
.chartTip.show{ opacity:1; }

</style>
</head>
<body>
<div class="wrap">
  <header class="hero">
    <div class="heroRow">
      <div>
        <h1>4周减脂打卡（训练 + 饮食 + 食谱 + 购物清单）</h1>
        <div class="muted">中餐｜低预算｜膝友好下肢｜本地自动保存（Safari）｜可导出/导入备份</div>
      </div>
      <div class="heroMeta">
        <span class="badge">💾 <strong>本地保存</strong></span>
        <span class="badge">📱 <strong>Safari 适配</strong></span>
        <span class="badge">⌚️ <strong>Watch 快捷</strong></span>
      </div>
    </div>
  </header>

  <div class="nav" id="nav"></div>

  <!-- 面板：总览 -->
  <div class="panel" id="panel-dashboard">
    
  <div class="card todayBoard" id="todayBoard">
    <div class="tbTop">
      <div>
        <div class="tbTitle">今日看板</div>
        <div class="tbSub" id="tbSub">—</div>
      </div>
      <div class="tbPills" id="tbPills"></div>
    </div>
    <div style="height:10px;"></div>
    <div class="progressBar" title="今日任务完成度"><div id="tbProg"></div></div>

    <div class="tbGrid">
      <div class="tbBox">
        <div class="row" style="justify-content:space-between;">
          <div><strong>今日训练</strong></div>
          <div class="pill" id="tbPlanPill"><span class="muted">—</span></div>
        </div>
        <div class="hr"></div>
        <div class="small" id="tbPlanDetail">—</div>
        <div class="tbActions" style="margin-top:12px;">
          <div class="tbMiniBtn ok" data-tb="done">⭐️ 标记完成</div>
          <div class="tbMiniBtn warnOn" data-tb="jump">🎯 跳到今天</div>
        </div>
      </div>

      <div class="tbBox">
        <div class="row" style="justify-content:space-between;">
          <div><strong>今日任务</strong></div>
          <div class="pill"><span class="muted">一键勾选</span></div>
        </div>
        <div class="hr"></div>
        <div class="tbActions" id="tbTasks"></div>
        <div class="hr"></div>
        <div class="row" style="justify-content:space-between;">
          <div class="small muted">饮食快速查看</div>
          <button class="primary" id="tbToFood" style="padding:9px 12px;">去饮食页</button>
        </div>
        <div class="small" id="tbMeals" style="margin-top:8px;">—</div>
      </div>
    </div>
  </div>

<div class="grid">
      <div class="card">
        <h2>设置 & 进度</h2>
        <div class="row">
          <div>
            <label>开始日期（建议周一）</label><br/>
            <input id="startDate" type="date" />
          </div>
          <div>
            <label>训练日热量</label><br/>
            <input id="trainKcal" type="number" min="1200" step="50" style="width:120px;" />
          </div>
          <div>
            <label>休息日热量</label><br/>
            <input id="restKcal" type="number" min="1200" step="50" style="width:120px;" />
          </div>
          <div>
            <label>蛋白目标(g/天)</label><br/>
            <input id="protein" type="number" min="80" step="5" style="width:120px;" />
          </div>
          <div style="margin-top:18px;">
            <button class="primary" id="regen">生成/刷新28天</button>
          </div>
        </div>

        <div class="hr"></div>
        <div class="row" id="kpis"></div>

        <div class="hr"></div>
        <div class="row">
          <button class="ok" id="exportBtn">导出备份(JSON)</button>
          <button class="ok" id="exportCSV">导出CSV</button>
          <span class="pill"><span class="muted">提醒时间</span>
            <input id="icsTime" type="time" value="20:30" style="width:110px; padding:6px 8px;"/>
          </span>
          <button class="warn" id="exportICS">生成提醒(.ics)</button>

          <label class="pill" style="cursor:pointer;">
            导入备份(JSON)
            <input id="importFile" type="file" accept="application/json" style="display:none;" />
          </label>
          <button class="danger" id="resetBtn">清空本机数据</button>
        </div>

        <div class="hr"></div>
        <div class="hint small">
          <div><strong>训练安排：</strong>周一上肢A｜周二下肢A(膝友好)｜周三有氧+核心｜周四上肢B｜周五下肢B(膝友好)｜周六可选有氧｜周日休息</div>
          <div><strong>进步规则：</strong>大动作做到“还剩2次力竭余量（RIR≈2）”。同重量能做到区间上限→下次加重量2.5–5%。</div>
        </div>
      </div>

      <div class="card">
        <h2>今日快捷</h2>
        <div id="todayBox" class="muted">设置开始日期后自动显示今天。</div>
        <div class="hr"></div>
        <h2>每周训练打卡（4周）</h2>
        <div id="weekly"></div>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <h2>体重 / 腰围趋势（本地记录）</h2>
      <div class="row">
        <div>
          <label>日期</label><br/>
          <input id="bwDate" type="date" />
        </div>
        <div>
          <label>体重(kg)</label><br/>
          <input id="bwWeight" type="number" step="0.1" min="30" style="width:120px;" />
        </div>
        <div>
          <label>腰围(cm)</label><br/>
          <input id="bwWaist" type="number" step="0.1" min="40" style="width:120px;" />
        </div>
        <div style="margin-top:18px;">
          <button class="ok" id="bwSave">保存记录</button>
          <button class="warn" id="bwClear">清空曲线</button>
        </div>
      </div>
      <div class="split" style="margin-top:10px;">
        <div>
          <div class="small">体重趋势</div>
          <canvas id="chartWeight" width="900" height="320"></canvas>
        </div>
        <div>
          <div class="small">腰围趋势</div>
          <canvas id="chartWaist" width="900" height="320"></canvas>
        </div>
      </div>
      <div class="small" id="bwStats" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- 面板：每日打卡 -->
  <div class="panel" id="panel-daily" style="display:none;">
    <div class="card">
      <h2>每日打卡（28天）</h2>
      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th style="width:105px;">日期</th>
              <th style="width:70px;">星期</th>
              <th style="width:140px;">训练类型</th>
              <th>任务（勾选）</th>
              <th style="width:310px;">中餐菜单（可下拉替换）</th>
              <th style="width:95px;">完成</th>
            </tr>
          </thead>
          <tbody id="daysBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 面板：训练 -->
  <div class="panel" id="panel-training" style="display:none;">
    <div class="grid">
      <div class="card">
        <h2>训练计划（膝友好版）</h2>
        <div id="trainingPlan"></div>
        <div class="hr"></div>
        <div class="hint small">
          <strong>膝盖规则：</strong>训练中疼痛≤3/10可继续；>3/10立刻换动作/减幅度。第二天肿胀或刺痛明显→本周下肢减量30–50%，有氧优先单车/游泳。
        </div>
      </div>

      <div class="card">
        <h2>训练日志（按日期记录）</h2>
        <div class="row">
          <div>
            <label>日期</label><br/>
            <input id="logDate" type="date" />
          </div>
          <div>
            <label>当天训练</label><br/>
            <select id="logPlan"></select>
          </div>
          <div>
            <label>范围</label><br/>
            <select id="liftRange">
              <option value="all" selected>全部</option>
              <option value="30">近30天</option>
              <option value="14">近14天</option>
            </select>
          </div>
          <div style="margin-top:18px;">
            <button class="primary" id="loadLog">载入</button>
            <button class="ok" id="saveLog">保存</button>
          </div>
        </div>
        <div class="hr"></div>
        <div id="logEditor" class="muted">选择日期和训练类型后点击“载入”。</div>
        <div class="hr"></div>
        <h2>力量进步趋势</h2>
        <div class="row">
          <div>
            <label>动作1</label><br/>
            <select id="liftEx1"></select>
          </div>
          <div>
            <label>动作2</label><br/>
            <select id="liftEx2"></select>
          </div>
          <div>
            <label>动作3</label><br/>
            <select id="liftEx3"></select>
          </div>
          <div>
            <label>指标</label><br/>
            <select id="liftMetric">
              <option value="maxw">最高重量(kg)</option>
              <option value="e1rm">估算1RM</option>
            </select>
          </div>
          <div style="margin-top:18px;">
            <button class="primary" id="refreshLift">刷新</button>
          </div>
        </div>
        <div style="margin-top:10px;">
          <div class="chartWrap">
            <div id="chartTip" class="chartTip"></div>
            <canvas id="liftChart" width="900" height="320"></canvas>
          </div>
          <div class="small" id="liftStats" style="margin-top:8px;"></div>
        </div>

      </div>
    </div>
  </div>

  <!-- 面板：食谱 & 购物清单 -->
  <div class="panel" id="panel-food" style="display:none;">
    <div class="grid">
      <div class="card">
        <h2>中餐食谱库（低预算）</h2>
        <div class="split">
          <div>
            <div class="muted">蛋白主菜（优先）</div>
            <ul id="recipesProtein"></ul>
          </div>
          <div>
            <div class="muted">蔬菜/汤/加餐</div>
            <ul id="recipesVeg"></ul>
          </div>
        </div>
        <div class="hr"></div>
        <h2>自定义食谱（本地保存）</h2>
        <div id="recipeMgr" class="small">
          <div class="split">
            <div>
              <label>食谱名</label><br/>
              <input id="rName" placeholder="例如：黑椒牛肉+青菜" style="width:100%;" />
              <div style="height:8px;"></div>
              <label>类型（勾选）</label>
              <div class="chk"><input type="checkbox" id="rTagB"/> 早餐</div>
              <div class="chk"><input type="checkbox" id="rTagL"/> 午餐</div>
              <div class="chk"><input type="checkbox" id="rTagD"/> 晚餐</div>
              <div class="chk"><input type="checkbox" id="rTagS"/> 加餐</div>
              <div style="height:8px;"></div>
              <label>预算</label><br/>
              <select id="rBudget" style="width:100%;">
                <option value="低">低</option>
                <option value="中">中</option>
                <option value="高">高</option>
              </select>
            </div>
            <div>
              <label>食材（用于购物清单，可简单写）</label><br/>
              <textarea id="rIng" rows="9" style="width:100%;" class="mono"
                placeholder="每行一个，例如：&#10;鸡胸肉 200g&#10;蔬菜（综合） 500g&#10;食用油 8g"></textarea>
              <div style="height:8px;"></div>
              <button class="ok" id="addRecipe">添加到食谱库</button>
              <button class="danger" id="clearRecipes">清空自定义食谱</button>
            </div>
          </div>
          <div class="hr"></div>
          <div class="muted">已添加的自定义食谱：</div>
          <div id="recipeList" class="small"></div>
        </div>

          </div>
        </div>
      </div>

      <div class="card">
        <h2>一键生成购物清单</h2>
        <div class="row">
          <div>
            <label>从第几天开始</label><br/>
            <select id="shopStart"></select>
          </div>
          <div>
            <label>生成天数</label><br/>
            <select id="shopDays">
              <option value="7">未来7天</option>
              <option value="14">未来14天</option>
            </select>
          </div>
          <div style="margin-top:18px;">
            <button class="primary" id="genShop">生成清单</button>
            <button class="ok" id="copyShop">复制清单</button>
          </div>
        </div>
        <div class="hr"></div>
        <div class="small">Safari 可能限制“自动复制”，若失败请手动全选复制。</div>
        <div class="hr"></div>
        <textarea id="shopOut" rows="16" style="width:100%;" class="mono" placeholder="这里会生成购物清单…"></textarea>
      </div>
    </div>
  </div>
  <div class="grid" style="margin-top:12px;">
    <div class="card" id="takeoutCalc">
      <h2>外卖/食堂估算（快速算热量+蛋白）</h2>
      <div class="small muted">估算值用于“控量/对比”。你也可以把结果写进“今天备注”。</div>
      <div class="hr"></div>
      <div class="twoCol">
        <div>
          <label>主蛋白</label><br/>
          <select id="toProt" style="width:100%;">
            <option value="chicken" selected>鸡胸/去皮鸡腿（熟）</option>
            <option value="beeflean">瘦牛肉（熟）</option>
            <option value="fish">鱼/虾（熟）</option>
            <option value="porklean">瘦猪肉（熟）</option>
            <option value="tofu">豆腐/豆干</option>
          </select>
          <div style="height:8px;"></div>
          <label>蛋白份量（克）</label><br/>
          <input id="toProtG" type="number" min="0" step="10" value="200" style="width:100%;"/>
          <div style="height:8px;"></div>
          <label>蔬菜（克）</label><br/>
          <input id="toVegG" type="number" min="0" step="50" value="500" style="width:100%;"/>
        </div>
        <div>
          <label>主食</label><br/>
          <select id="toCarb" style="width:100%;">
            <option value="0">不吃主食</option>
            <option value="0.5">半碗米饭</option>
            <option value="1" selected>一碗米饭</option>
            <option value="1.5">一碗半米饭</option>
          </select>
          <div style="height:8px;"></div>
          <label>用油程度（估算）</label><br/>
          <select id="toOil" style="width:100%;">
            <option value="5">少油</option>
            <option value="10" selected>正常</option>
            <option value="20">偏油/油多</option>
          </select>
          <div style="height:8px;"></div>
          <label>额外：饮料/甜品（kcal，可选）</label><br/>
          <input id="toExtra" type="number" min="0" step="50" value="0" style="width:100%;"/>
        </div>
      </div>
      <div class="hr"></div>
      <div class="row">
        <button class="primary" id="calcTakeout">计算</button>
        <button class="ok" id="copyTakeout">复制结果</button>
        <button class="warn" id="writeTakeout">写入今天备注</button>
      </div>
      <div class="hr"></div>
      <div class="pill"><span class="muted">估算热量</span> <strong id="toKcal">-</strong> <span class="muted">kcal</span></div>
      <div class="pill"><span class="muted">估算蛋白</span> <strong id="toP">-</strong> <span class="muted">g</span></div>
      <div class="small" id="toHint" style="margin-top:8px;"></div>
    </div>

    <div class="card" id="weekMenu">
      <h2>一键排 7 天菜单（更贴近外卖/食堂/家常）</h2>
      <div class="row">
        <div>
          <label>从哪天开始</label><br/>
          <select id="wmStart"></select>
        </div>
        <div>
          <label>预算筛选</label><br/>
          <select id="wmBudget">
            <option value="all" selected>不限</option>
            <option value="低">只要低预算</option>
            <option value="中">低+中</option>
          </select>
        </div>
        <div>
          <label>来源</label><br/>
          <select id="wmMode">
            <option value="all" selected>不限</option>
            <option value="家常">家常</option>
            <option value="外卖/食堂">外卖/食堂</option>
          </select>
        </div>
        <div>
          <label>口味</label><br/>
          <select id="wmFlavor">
            <option value="all" selected>不限</option>
            <option value="清淡">清淡</option>
            <option value="重口">重口</option>
          </select>
        </div>
        <div>
          <label>蛋白优先</label><br/>
          <select id="wmProtein">
            <option value="1" selected>是（午/晚优先高蛋白）</option>
            <option value="0">否（随机均匀）</option>
          </select>
        </div>
        <div>
          <label>尽量不重复</label><br/>
          <select id="wmVar">
            <option value="1" selected>是</option>
            <option value="0">否</option>
          </select>
        </div>
        <div style="margin-top:18px;">
          <button class="primary" id="genWeekMenu">生成</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="row">
        <button class="ok" id="applyWeekMenu">应用到日程（覆盖这7天菜单）</button>
        <button class="warn" id="copyWeekMenu">复制表格</button>
      </div>
      <div class="hr"></div>
      <div class="scroll" style="max-height:360px;">
        <table>
          <thead>
            <tr>
              <th style="width:105px;">日期</th>
              <th>早餐</th>
              <th>午餐</th>
              <th>加餐</th>
              <th>晚餐</th>
            </tr>
          </thead>
          <tbody id="wmBody"></tbody>
        </table>
      </div>
      <div class="small muted" style="margin-top:8px;">提示：生成后不满意可以再点“生成”；满意再点“应用到日程”。</div>
    </div>
  </div>

  <!-- 面板：日历 -->
  <div class="panel" id="panel-calendar" style="display:none;">
    <div class="grid">
      <div class="card">
        <h2>28天日历（点击日期跳转到每日打卡）</h2>
        <div class="small muted">绿色=已完成｜橙色=未完成｜红色=已过期未完成（仅作提示）</div>
        <div class="hr"></div>
        <div id="calHeader" class="row"></div>
        <div style="height:8px;"></div>
        <div id="calWeekHead" class="calWeekHead"></div>
        <div id="calGrid" class="calGrid"></div>
      </div>
      <div class="card">
        <h2>快捷操作</h2>
        <div class="hint small">
          <div>• 想“像小程序”一样：iPhone Safari 打开后 → 分享 → 添加到主屏幕。</div>
          <div>• 想每天提醒：在「总览」里点“生成提醒(.ics)”导入到 iPhone 日历并开启提醒。</div>
          <div>• 想快速找漏打：看本页橙/红色格子。</div>
        </div>
        <div class="hr"></div>
        <div class="muted small">提示：如果你没设置开始日期或没生成28天，本页不会显示。</div>
      </div>
    </div>
  </div>

</div>

<script>
/** 基础工具 */
const STORAGE_KEY = "cut4w_plus_v1";
const DOW = ["日","一","二","三","四","五","六"];
const $ = (id) => document.getElementById(id);
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m])); }
function dateToKey(d){ const yyyy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,"0"); const dd=String(d.getDate()).padStart(2,"0"); return `${yyyy}-${mm}-${dd}`; }
function keyToDate(key){ const [y,m,d]=key.split("-").map(Number); return new Date(y,m-1,d); }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

/** 训练计划 */
const TRAIN_PLAN = [
  { code:"U_A", name:"上肢A", tagClass:"a" },
  { code:"L_A", name:"下肢A(膝友好)", tagClass:"b" },
  { code:"Cardio", name:"有氧+核心", tagClass:"c" },
  { code:"U_B", name:"上肢B", tagClass:"a" },
  { code:"L_B", name:"下肢B(膝友好)", tagClass:"b" },
  { code:"Opt", name:"可选有氧", tagClass:"c" },
  { code:"Rest", name:"休息", tagClass:"" },
];

const WORKOUTS = {
  U_A: { title:"上肢A（推+拉）", warmup:["跑步机坡走/单车 5分钟","肩胛激活：面拉轻重量 2×15"],
    items:[
      {ex:"卧推（杠铃/史密斯）", sets:4, reps:"6–10", note:"RIR≈2；休息90–150s"},
      {ex:"坐姿划船（器械/绳索）", sets:4, reps:"8–12", note:"顶峰收缩1秒"},
      {ex:"上斜哑铃卧推", sets:3, reps:"8–12", note:"下放控制"},
      {ex:"高位下拉（宽/中立握）", sets:3, reps:"8–12", note:"肩胛下沉"},
      {ex:"哑铃侧平举", sets:3, reps:"12–15", note:"别耸肩"},
      {ex:"绳索下压（肱三）", sets:3, reps:"10–15", note:"肘固定"},
      {ex:"哑铃弯举", sets:"2–3", reps:"10–15", note:"不借力"},
    ],
    finisher:"可选：坡走/椭圆机 12–15分钟"
  },
  L_A: { title:"下肢A（膝友好｜股四+后链）", warmup:["单车 5分钟","弹力带TKE 2×20","徒手臀桥 2×15"],
    items:[
      {ex:"腿举（脚位略高）", sets:4, reps:"10–15", note:"不锁死膝"},
      {ex:"罗马尼亚硬拉（RDL）", sets:4, reps:"6–10", note:"髋折叠；背挺"},
      {ex:"腿弯举（腘绳肌）", sets:3, reps:"10–15", note:"全程控制"},
      {ex:"哈克/盒式深蹲（不痛幅度）", sets:3, reps:"8–12", note:"膝痛就换台阶上步"},
      {ex:"提踵", sets:4, reps:"10–15", note:"顶峰停1秒"},
      {ex:"卷腹/器械卷腹", sets:3, reps:"12–20", note:"呼气收紧"},
    ],
    finisher:"可选：单车轻松转 10分钟"
  },
  Cardio: { title:"有氧 + 核心（燃脂日）", warmup:["热身 5分钟（单车/椭圆机）"],
    items:[
      {ex:"稳态有氧（单车/椭圆机/坡走）", sets:1, reps:"45–60分钟", note:"能说话但不想多说"},
      {ex:"核心：平板支撑", sets:3, reps:"40–60秒", note:"骨盆别塌"},
      {ex:"核心：死虫 或 Pallof Press", sets:3, reps:"10–12/侧", note:"慢、稳"},
    ],
    finisher:"结束拉伸：髋屈肌/臀/腘绳/胸背"
  },
  U_B: { title:"上肢B（肩推+背部强化）", warmup:["单车/划船机 5分钟","面拉轻重量 2×15"],
    items:[
      {ex:"坐姿推肩（器械/哑铃）", sets:4, reps:"6–10", note:"腰别反弓"},
      {ex:"胸托划船/器械划船", sets:4, reps:"8–12", note:"顶峰夹背"},
      {ex:"哑铃卧推 或 夹胸器械", sets:3, reps:"8–12", note:"动作标准"},
      {ex:"引体辅助/窄握下拉", sets:3, reps:"8–12", note:"肩胛下沉"},
      {ex:"面拉（后束）", sets:3, reps:"12–15", note:"肘抬高一点"},
      {ex:"过顶绳索臂屈伸（肱三）", sets:3, reps:"10–15", note:"肘固定"},
      {ex:"锤式弯举", sets:"2–3", reps:"10–15", note:"别摆动"},
    ],
    finisher:"可选：椭圆机 10–15分钟"
  },
  L_B: { title:"下肢B（膝友好｜臀腿主导）", warmup:["单车 5分钟","臀中肌外展机 2×15（轻）"],
    items:[
      {ex:"臀推（杠铃/史密斯）", sets:4, reps:"8–12", note:"顶峰夹臀1秒"},
      {ex:"陷阱杠硬拉 或 RDL", sets:3, reps:"5–8 / 6–10", note:"优先舒服的"},
      {ex:"分腿蹲（短步、胫骨尽量垂直）", sets:3, reps:"8–12/侧", note:"膝不舒服改外展机"},
      {ex:"腿弯举", sets:3, reps:"10–15", note:"控制下放"},
      {ex:"外展机（臀中肌）", sets:3, reps:"12–20", note:"稳定发力"},
      {ex:"悬垂举腿/卷腹", sets:3, reps:"10–15", note:"别摆"},
    ],
    finisher:"可选：坡走 10分钟"
  },
  Opt: { title:"可选低强度有氧 + 拉伸", warmup:["热身 5分钟"],
    items:[
      {ex:"快走/单车/游泳", sets:1, reps:"45–75分钟", note:"轻松可聊天"},
      {ex:"拉伸", sets:1, reps:"10分钟", note:"髋屈肌/臀/腘绳/胸背"},
    ],
    finisher:"目标：恢复+提高总消耗"
  },
  Rest: { title:"休息（散步即可）", warmup:[],
    items:[
      {ex:"散步", sets:1, reps:"20–40分钟", note:"放松"},
      {ex:"轻拉伸", sets:1, reps:"5–10分钟", note:"看身体"},
    ],
    finisher:""
  }
};

/** 食谱（简化版：供下拉和购物清单） */
const ING = {
  oats:{label:"燕麦", unit:"g"},
  milk:{label:"牛奶（低脂）", unit:"ml"},
  yogurt:{label:"无糖酸奶", unit:"g"},
  egg:{label:"鸡蛋", unit:"个"},
  chicken:{label:"鸡胸肉", unit:"g"},
  shrimp:{label:"虾仁", unit:"g"},
  tofu:{label:"豆腐", unit:"g"},
  tofu_dry:{label:"豆干", unit:"g"},
  tuna:{label:"金枪鱼罐头（水浸）", unit:"罐"},
  veg_mix:{label:"蔬菜（综合）", unit:"g"},
  broccoli:{label:"西兰花/菜花", unit:"g"},
  tomato:{label:"番茄", unit:"个"},
  mushroom:{label:"菌菇", unit:"g"},
  cucumber:{label:"黄瓜", unit:"根"},
  banana:{label:"香蕉", unit:"根"},
  apple:{label:"水果（1份）", unit:"份"},
  oil:{label:"食用油", unit:"g"},
  soy_sauce:{label:"酱油", unit:"ml"},
  garlic:{label:"蒜/姜（调味）", unit:"份"},
};

const BASE_RECIPES = [
  {name:"燕麦+牛奶+鸡蛋2个", tags:["早餐"], budget:"低", ingredients:[["oats",60],["milk",300],["egg",2],["banana",1]]},
  {name:"无糖酸奶+水果", tags:["早餐"], budget:"低", ingredients:[["yogurt",300],["apple",1]]},
  {name:"豆干+卤蛋2个+黄瓜", tags:["早餐"], budget:"低", ingredients:[["tofu_dry",100],["egg",2],["cucumber",1]]},

  {name:"照烧鸡胸+青菜", tags:["午餐","晚餐"], budget:"低", ingredients:[["chicken",200],["veg_mix",500],["oil",8],["soy_sauce",15],["garlic",1]]},
  {name:"番茄炒蛋+青菜", tags:["午餐","晚餐"], budget:"低", ingredients:[["egg",3],["tomato",2],["veg_mix",400],["oil",8],["garlic",1]]},
  {name:"虾仁滑蛋+青菜", tags:["午餐","晚餐"], budget:"中", ingredients:[["shrimp",200],["egg",2],["veg_mix",450],["oil",8],["garlic",1]]},
  {name:"家常豆腐（少油）", tags:["午餐","晚餐"], budget:"低", ingredients:[["tofu",300],["veg_mix",450],["oil",10],["soy_sauce",15],["garlic",1]]},
  {name:"金枪鱼拌饭（简易）", tags:["午餐","晚餐"], budget:"低", ingredients:[["tuna",1],["veg_mix",350]]},

  {name:"菌菇番茄豆腐汤", tags:["午餐","晚餐"], budget:"低", ingredients:[["tofu",200],["mushroom",200],["tomato",2],["garlic",1]]},
  {name:"清炒西兰花/菜花", tags:["午餐","晚餐"], budget:"低", ingredients:[["broccoli",400],["oil",6],["garlic",1]]},
  {name:"凉拌黄瓜", tags:["午餐","晚餐"], budget:"低", ingredients:[["cucumber",1],["soy_sauce",10],["garlic",1]]},

  {name:"无糖酸奶200g", tags:["加餐"], budget:"低", ingredients:[["yogurt",200]]},
  {name:"水果1份", tags:["加餐"], budget:"低", ingredients:[["apple",1]]},
  {name:"卤蛋2个", tags:["加餐"], budget:"低", ingredients:[["egg",2]]},
  {name:"豆干100g", tags:["加餐"], budget:"低", ingredients:[["tofu_dry",100]]},

  // —— 外卖/食堂（估算用/不进购物清单：ingredients 可为空）——
  {name:"食堂：鸡腿去皮+双素+半碗饭", tags:["午餐","晚餐","清淡"], budget:"低", src:"外卖/食堂", ingredients:[], others:[{name:"鸡腿去皮(熟)",amount:200,unit:"g"},{name:"时蔬",amount:500,unit:"g"},{name:"米饭",amount:0.5,unit:"碗"}]},
  {name:"食堂：卤牛肉+双素+半碗饭", tags:["午餐","晚餐","清淡"], budget:"中", src:"外卖/食堂", ingredients:[], others:[{name:"卤牛肉(熟)",amount:180,unit:"g"},{name:"时蔬",amount:500,unit:"g"},{name:"米饭",amount:0.5,unit:"碗"}]},
  {name:"外卖：黄焖鸡（去皮少汁）+双素+半饭", tags:["午餐","晚餐","重口"], budget:"中", src:"外卖/食堂", ingredients:[], others:[{name:"黄焖鸡(去皮少汁)",amount:1,unit:"份"},{name:"蔬菜配菜",amount:2,unit:"份"},{name:"米饭",amount:0.5,unit:"碗"}]},
  {name:"外卖：麻辣烫（清汤）+加鸡胸+多蔬菜", tags:["午餐","晚餐","重口"], budget:"中", src:"外卖/食堂", ingredients:[], others:[{name:"麻辣烫清汤",amount:1,unit:"份"},{name:"鸡胸",amount:200,unit:"g"},{name:"蔬菜",amount:600,unit:"g"}]},
  {name:"外卖：烤鱼（少油）+青菜", tags:["晚餐","重口"], budget:"中", src:"外卖/食堂", ingredients:[], others:[{name:"烤鱼(少油)",amount:1,unit:"份"},{name:"青菜",amount:1,unit:"份"}]},
  {name:"外卖：沙县/轻食 鸡胸+蔬菜+半饭", tags:["午餐","晚餐","清淡"], budget:"低", src:"外卖/食堂", ingredients:[], others:[{name:"鸡胸",amount:200,unit:"g"},{name:"蔬菜",amount:500,unit:"g"},{name:"米饭",amount:0.5,unit:"碗"}]},

];

function getAllRecipes(){
  const custom = Array.isArray(state.customRecipes) ? state.customRecipes : [];
  const safeCustom = custom.filter(r=>r && r.name && Array.isArray(r.tags));
  return BASE_RECIPES.concat(safeCustom);
}

function recipeByName(name){ return getAllRecipes().find(r=>r.name===name); }
function mealOptions(tag){
  const list = getAllRecipes().filter(r=>r.tags.includes(tag));
  return list.map(r=>`<option value="${escapeHtml(r.name)}">${escapeHtml(r.name)}（${r.budget}）</option>`).join("");
}
const MEAL_DEFAULTS = {
  breakfast:["燕麦+牛奶+鸡蛋2个","无糖酸奶+水果","豆干+卤蛋2个+黄瓜"],
  lunch:["照烧鸡胸+青菜","番茄炒蛋+青菜","家常豆腐（少油）","金枪鱼拌饭（简易）"],
  snack:["无糖酸奶200g","水果1份","卤蛋2个","豆干100g"],
  dinner:["照烧鸡胸+青菜","菌菇番茄豆腐汤","番茄炒蛋+青菜","虾仁滑蛋+青菜"]
};

/** 状态 */
const defaultState = () => ({
  startDate:"",
  trainKcal:2400,
  restKcal:2200,
  protein:180,
  weeklyDone:Array.from({length:4},()=>({U_A:false,L_A:false,Cardio:false,U_B:false,L_B:false,Opt:false,Rest:false})),
  days:{},
  body:{logs:{}},
  trainingLogs:{},
  customRecipes:[]
});
function loadState(){
  try{ const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return defaultState(); return Object.assign(defaultState(), JSON.parse(raw)); }
  catch(e){ return defaultState(); }
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
let state = loadState();
  // quick actions (Shortcuts / Watch)
  applyQuickActionFromURL();

/** 渲染函数 */
function tagForPlan(code){
  const p = TRAIN_PLAN.find(x=>x.code===code);
  if(!p) return `<span class="tag">-</span>`;
  if(code==="Rest") return `<span class="tag">休息</span>`;
  return `<span class="tag ${p.tagClass}">${p.name}</span>`;
}

function ensureDays(){
  if(!state.startDate) return;
  const start = keyToDate(state.startDate);
  for(let i=0;i<28;i++){
    const k = dateToKey(addDays(start,i));
    if(!state.days[k]){
      const plan = TRAIN_PLAN[i%7];
      state.days[k] = {
        planCode: plan.code,
        tasks:{kcalOk:false,proteinOk:false,vegOk:false,waterOk:false,stepsOk:false,sleepOk:false,noSugarDrink:false},
        meals:{
          breakfast: MEAL_DEFAULTS.breakfast[i%MEAL_DEFAULTS.breakfast.length],
          lunch: MEAL_DEFAULTS.lunch[i%MEAL_DEFAULTS.lunch.length],
          snack: MEAL_DEFAULTS.snack[i%MEAL_DEFAULTS.snack.length],
          dinner: MEAL_DEFAULTS.dinner[i%MEAL_DEFAULTS.dinner.length],
        },
        done:false,
        notes:""
      };
    }
  }
  saveState();
}

function renderKPIs(){
  if(!state.startDate){ $("kpis").innerHTML = `<span class="muted">先设置开始日期并生成28天。</span>`; return; }
  const start=keyToDate(state.startDate);
  const keys=Array.from({length:28},(_,i)=>dateToKey(addDays(start,i)));
  const doneCount=keys.filter(k=>state.days[k]?.done).length;
  // streak
  const doneFlags = keys.map(k => !!state.days[k]?.done);
  let curStreak = 0;
  for(let i=doneFlags.length-1;i>=0;i--){
    if(doneFlags[i]) curStreak++;
    else break;
  }
  let bestStreak = 0, run = 0;
  for(const v of doneFlags){
    if(v){ run++; bestStreak = Math.max(bestStreak, run); }
    else run = 0;
  }

  let trainTicks=0; state.weeklyDone.forEach(w=>Object.values(w).forEach(v=>{if(v) trainTicks++;}));
  let taskChecks=0, taskTotal=0;
  keys.forEach(k=>{
    const d=state.days[k]; if(!d) return;
    const vals=Object.values(d.tasks); taskTotal+=vals.length; taskChecks+=vals.filter(Boolean).length;
  });
  const pct = taskTotal ? Math.round(taskChecks*100/taskTotal) : 0;

  $("kpis").innerHTML = `
    <span class="pill"><strong>${doneCount}</strong><span class="muted">/28 天完成</span></span>
    <span class="pill"><strong>${curStreak}</strong><span class="muted">连续完成</span></span>
    <span class="pill"><strong>${bestStreak}</strong><span class="muted">最高连续</span></span>
    <span class="pill"><strong>${pct}%</strong><span class="muted">任务勾选率</span></span>
    <span class="pill"><strong>${trainTicks}</strong><span class="muted">周训练勾选</span></span>
    <span class="pill"><strong>${state.trainKcal}</strong><span class="muted">训练日kcal</span></span>
    <span class="pill"><strong>${state.restKcal}</strong><span class="muted">休息日kcal</span></span>
    <span class="pill"><strong>${state.protein}g</strong><span class="muted">蛋白目标</span></span>
  `;
}

function renderWeekly(){
  const headers=["周次","上肢A","下肢A","有氧+核心","上肢B","下肢B","可选有氧","休息"];
  const codes=["U_A","L_A","Cardio","U_B","L_B","Opt","Rest"];
  let html=`<table><thead><tr>${headers.map(h=>`<th>${h}</th>`).join("")}</tr></thead><tbody>`;
  for(let w=0; w<4; w++){
    html += `<tr><td>第${w+1}周</td>${
      codes.map(c=>{
        const id=`wk_${w}_${c}`;
        const checked=state.weeklyDone[w]?.[c]?"checked":"";
        return `<td><input type="checkbox" id="${id}" ${checked}/></td>`;
      }).join("")
    }</tr>`;
  }
  html += `</tbody></table>`;
  $("weekly").innerHTML = html;

  for(let w=0; w<4; w++){
    codes.forEach(c=>{
      const el = $(`wk_${w}_${c}`);
      el.addEventListener("change", ()=>{
        state.weeklyDone[w][c] = el.checked;
        saveState(); renderKPIs();
      });
    });
  }
}

function checkboxLine(dayKey, taskKey, labelText){
  const checked = state.days[dayKey]?.tasks?.[taskKey] ? "checked" : "";
  return `<div class="chk"><input type="checkbox" data-task="${dayKey}|${taskKey}" ${checked}/><span>${escapeHtml(labelText)}</span></div>`;
}

function renderTodayBox(){
  if(!state.startDate){ $("todayBox").innerHTML = `<span class="muted">设置开始日期后自动显示。</span>`; return; }
  const todayKey = dateToKey(new Date());
  const d = state.days[todayKey];
  if(!d){ $("todayBox").innerHTML = `<span class="muted">今天不在28天周期内（或未生成）。</span>`; return; }
  const plan = TRAIN_PLAN.find(x=>x.code===d.planCode)?.name || d.planCode;
  const doneTasks = Object.values(d.tasks).filter(Boolean).length;
  const totalTasks = Object.values(d.tasks).length;
  $("todayBox").innerHTML = `
    <div class="row" style="justify-content:space-between;">
      <div>
        <div><strong>${todayKey}</strong>（周${DOW[new Date().getDay()]}）</div>
        <div class="small">训练：${escapeHtml(plan)}</div>
      </div>
      <div class="pill"><strong>${doneTasks}/${totalTasks}</strong><span class="muted">任务</span></div>
      <div class="pill"><strong>${d.done ? "已完成" : "未完成"}</strong></div>
    </div>
    <div class="small" style="margin-top:8px;">
      早餐：${escapeHtml(d.meals.breakfast)}<br/>
      午餐：${escapeHtml(d.meals.lunch)}<br/>
      加餐：${escapeHtml(d.meals.snack)}<br/>
      晚餐：${escapeHtml(d.meals.dinner)}
    </div>
  `;
}

function renderDays(){
  if(!state.startDate){ $("daysBody").innerHTML = `<tr><td colspan="6" class="muted">请先设置开始日期并点击“生成/刷新28天”。</td></tr>`; return; }
  ensureDays();
  const start = keyToDate(state.startDate);

  let rows="";
  for(let i=0;i<28;i++){
    const day = addDays(start,i);
    const key = dateToKey(day);
    const dow = DOW[day.getDay()];
    const d = state.days[key];

    const taskHtml = `
      ${checkboxLine(key,"kcalOk","热量达标（训练日"+state.trainKcal+" / 休息日"+state.restKcal+"）")}
      ${checkboxLine(key,"proteinOk","蛋白≥"+state.protein+"g")}
      ${checkboxLine(key,"vegOk","蔬菜≥800g")}
      ${checkboxLine(key,"waterOk","饮水≥2.5L")}
      ${checkboxLine(key,"stepsOk","步数达标（8k→10k→12k）")}
      ${checkboxLine(key,"sleepOk","睡眠≥7h")}
      ${checkboxLine(key,"noSugarDrink","含糖饮料/酒=0")}
      <div class="small">备注：<input data-note="${key}" placeholder="可写膝盖/训练感受" style="width:92%;"/></div>
    `;

    const mealsHtml = `
      <div class="small">早：<select data-meal="${key}|breakfast">${mealOptions("早餐")}</select></div>
      <div class="small">午：<select data-meal="${key}|lunch">${mealOptions("午餐")}</select></div>
      <div class="small">加：<select data-meal="${key}|snack">${mealOptions("加餐")}</select></div>
      <div class="small">晚：<select data-meal="${key}|dinner">${mealOptions("晚餐")}</select></div>
    `;

    rows += `<tr id="dayrow-${key}">
      <td>${key}</td>
      <td>周${dow}</td>
      <td>${tagForPlan(d.planCode)}</td>
      <td>${taskHtml}</td>
      <td>${mealsHtml}</td>
      <td style="text-align:center;"><div class="chk"><input type="checkbox" data-done="${key}" ${d.done?"checked":""}/> 完成</div></td>
    </tr>`;
  }
  $("daysBody").innerHTML = rows;

  // bind meals/note/done
  for(let i=0;i<28;i++){
    const key = dateToKey(addDays(start,i));
    const d = state.days[key];

    document.querySelectorAll(`select[data-meal^="${key}|"]`).forEach(sel=>{
      const [k, which] = sel.getAttribute("data-meal").split("|");
      sel.value = state.days[k].meals[which];
      sel.addEventListener("change", ()=>{
        state.days[k].meals[which] = sel.value;
        saveState();
      });
    });

    const noteInput = document.querySelector(`input[data-note="${key}"]`);
    if(noteInput){
      noteInput.value = d.notes || "";
      noteInput.addEventListener("change", ()=>{
        state.days[key].notes = noteInput.value;
        saveState();
      });
    }

    const doneEl = document.querySelector(`input[data-done="${key}"]`);
    doneEl.addEventListener("change", ()=>{
      state.days[key].done = doneEl.checked;
      saveState(); renderKPIs(); renderTodayBox(); renderShopStart();
    });
  }

  // bind tasks
  document.querySelectorAll(`input[data-task]`).forEach(cb=>{
    cb.addEventListener("change", ()=>{
      const [key, t] = cb.getAttribute("data-task").split("|");
      state.days[key].tasks[t] = cb.checked;
      saveState(); renderKPIs(); renderTodayBox();
    });
  });

  renderTodayBox();
  renderShopStart();
}

function renderTrainingPlan(){
  let html="";
  Object.keys(WORKOUTS).forEach(code=>{
    const w = WORKOUTS[code];
    html += `
      <div class="hr"></div>
      <div class="row" style="justify-content:space-between;">
        <div><strong>${escapeHtml(w.title)}</strong></div>
        <div>${tagForPlan(code)}</div>
      </div>
      ${w.warmup?.length ? `<div class="small">热身：${w.warmup.map(escapeHtml).join("；")}</div>` : ""}
      <div style="margin-top:8px;">
        <table>
          <thead><tr><th>动作</th><th style="width:70px;">组数</th><th style="width:90px;">次数/时长</th><th>提示</th></tr></thead>
          <tbody>
            ${w.items.map(it=>`
              <tr><td>${escapeHtml(it.ex)}</td><td>${escapeHtml(it.sets)}</td><td>${escapeHtml(it.reps)}</td><td class="small">${escapeHtml(it.note||"")}</td></tr>
            `).join("")}
          </tbody>
        </table>
        ${w.finisher ? `<div class="small" style="margin-top:8px;">收尾：${escapeHtml(w.finisher)}</div>` : ""}
      </div>
    `;
  });
  $("trainingPlan").innerHTML = html;
}

function renderLogPlanOptions(){
  $("logPlan").innerHTML = TRAIN_PLAN.filter(p=>p.code!=="Rest")
    .map(p=>`<option value="${p.code}">${escapeHtml(p.name)}</option>`).join("");
}
function keyLog(dateKey, planCode){ return `${dateKey}|${planCode}`; }

function buildLogEditor(dateKey, planCode){
  const workout = WORKOUTS[planCode];
  if(!workout) return `<div class="muted">无此训练模板。</div>`;
  const k = keyLog(dateKey, planCode);
  const saved = state.trainingLogs[k] || { items:{}, notes:"" };

  let html = `<div class="small">每组填「重量kg」+「次数」。留空也能保存。</div><div class="hr"></div>`;
  workout.items.forEach(it=>{
    const ex = it.ex;
    const sets = (typeof it.sets === "number") ? it.sets : (parseInt(it.sets)||3);
    const arr = saved.items[ex] || Array.from({length:sets}, ()=>({w:"", r:""}));
    while(arr.length < sets) arr.push({w:"", r:""});
    while(arr.length > sets) arr.pop();

    const rows = [];
    for(let i=0;i<sets;i++){
      rows.push(`<tr>
        <td class="small">第${i+1}组</td>
        <td><input data-log="${ex}|${i}|w" placeholder="kg" style="width:90px;" value="${escapeHtml(arr[i].w)}"></td>
        <td><input data-log="${ex}|${i}|r" placeholder="次" style="width:90px;" value="${escapeHtml(arr[i].r)}"></td>
      </tr>`);
    }

    html += `
      <div class="hr"></div>
      <div class="row" style="justify-content:space-between;">
        <div><strong>${escapeHtml(ex)}</strong> <span class="small">（${escapeHtml(it.sets)}×${escapeHtml(it.reps)}）</span></div>
        <div class="small">${escapeHtml(it.note||"")}</div>
      </div>
      <table style="margin-top:6px;">
        <thead><tr><th style="width:80px;"></th><th style="width:110px;">重量</th><th style="width:110px;">次数</th></tr></thead>
        <tbody>${rows.join("")}</tbody>
      </table>
    `;
  });

  html += `<div class="hr"></div><label>训练备注</label>
    <textarea id="logNotes" rows="4" style="width:100%;" placeholder="例如：卧推最后一组RIR=1，膝盖2/10…">${escapeHtml(saved.notes||"")}</textarea>`;
  return html;
}

function loadLog(){
  const dateKey = $("logDate").value;
  const planCode = $("logPlan").value;
  if(!dateKey){ alert("先选日期"); return; }
  $("logEditor").innerHTML = buildLogEditor(dateKey, planCode);
}
function saveLog(){
  const dateKey = $("logDate").value;
  const planCode = $("logPlan").value;
  if(!dateKey){ alert("先选日期"); return; }
  const workout = WORKOUTS[planCode];
  const k = keyLog(dateKey, planCode);
  const data = { items:{}, notes: $("logNotes") ? $("logNotes").value : "" };

  workout.items.forEach(it=>{
    const ex = it.ex;
    const sets = (typeof it.sets === "number") ? it.sets : (parseInt(it.sets)||3);
    const arr = Array.from({length:sets}, ()=>({w:"", r:""}));
    for(let i=0;i<sets;i++){
      const wEl = document.querySelector(`input[data-log="${ex}|${i}|w"]`);
      const rEl = document.querySelector(`input[data-log="${ex}|${i}|r"]`);
      arr[i] = { w: (wEl?.value||"").trim(), r: (rEl?.value||"").trim() };
    }
    data.items[ex] = arr;
  });

  state.trainingLogs[k] = data;
  saveState();
  alert("已保存训练日志！");
}

/** 食谱页渲染 + 购物清单 */
function renderRecipes(){
  const allR = getAllRecipes();
  const protein = allR.filter(r=>r.tags.includes("午餐")||r.tags.includes("晚餐"));
    const veg = allR.filter(r=>r.tags.includes("加餐")||r.name.includes("汤")||r.name.includes("凉拌")||r.name.includes("西兰花"));
  $("recipesProtein").innerHTML = protein.map(r=>`<li>${escapeHtml(r.name)} <span class="small">（预算：${escapeHtml(r.budget)}）</span></li>`).join("");
  $("recipesVeg").innerHTML = veg.map(r=>`<li>${escapeHtml(r.name)} <span class="small">（预算：${escapeHtml(r.budget)}）</span></li>`).join("");
}

function renderShopStart(){
  const sel = $("shopStart");
  sel.innerHTML = "";
  if(!state.startDate){ sel.innerHTML = `<option value="">先设置开始日期</option>`; return; }
  const start = keyToDate(state.startDate);
  for(let i=0;i<28;i++){
    const key = dateToKey(addDays(start,i));
    sel.innerHTML += `<option value="${key}">${key}</option>`;
  }
  const todayKey = dateToKey(new Date());
  if(state.days[todayKey]) sel.value = todayKey;
}

function addToMap(map, ingKey, amount){ if(amount===0) return; map[ingKey] = (map[ingKey]||0) + amount; }

function formatAmount(k,val){
  if(["egg","banana","tomato","cucumber","tuna","apple"].includes(k)) return String(Math.round(val));
  if(["milk","soy_sauce"].includes(k)) return String(Math.round(val/10)*10);
  return String(Math.round(val/10)*10);
}


function parseCustomIngredients(text){
  const lines = String(text||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const parsed = [];
  for(const line of lines){
    const m = line.match(/^(.+?)\s+(\d+(?:\.\d+)?)\s*(\S+)?$/);
    if(m){
      parsed.push({name:m[1].trim(), amount:parseFloat(m[2]), unit:(m[3]||"")});
    }else{
      parsed.push({name:line, amount:null, unit:""});
    }
  }
  return parsed;
}

function customToRecipe(name,tags,budget,ingText){
  const parsed = parseCustomIngredients(ingText);
  const ingredients = [];
  const others = [];
  for(const it of parsed){
    const key = Object.keys(ING).find(k => ING[k].label === it.name);
    if(key && it.amount!=null){
      ingredients.push([key, it.amount]);
    }else{
      others.push(it);
    }
  }
  return {name, tags, budget, ingredients, others, _custom:true, _raw:ingText};
}

function renderRecipeManager(){
  const list = Array.isArray(state.customRecipes)?state.customRecipes:[];
  if(!list.length){
    $("recipeList").innerHTML = `<div class="muted">暂无自定义食谱。</div>`;
    return;
  }
  $("recipeList").innerHTML = list.map((r,idx)=>{
    const tg = (r.tags||[]).join(" / ");
    return `<div class="row" style="justify-content:space-between; border-bottom:1px solid rgba(255,255,255,.06); padding:6px 0;">
      <div><strong>${escapeHtml(r.name)}</strong> <span class="small">（${escapeHtml(r.budget||"低")}｜${escapeHtml(tg)}）</span></div>
      <button class="danger" data-delrecipe="${idx}">删除</button>
    </div>`;
  }).join("");

  document.querySelectorAll("button[data-delrecipe]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const idx = parseInt(btn.getAttribute("data-delrecipe"),10);
      state.customRecipes.splice(idx,1);
      saveState();
      renderRecipes();
      renderRecipeManager();
      renderDays();
    });
  });
}

function bindRecipeManager(){
  const addBtn = $("addRecipe");
  const clearBtn = $("clearRecipes");
  if(!addBtn || !clearBtn) return;

  addBtn.addEventListener("click", ()=>{
    const name = ($("rName").value||"").trim();
    if(!name){ alert("先填食谱名"); return; }
    const tags = [];
    if($("rTagB").checked) tags.push("早餐");
    if($("rTagL").checked) tags.push("午餐");
    if($("rTagD").checked) tags.push("晚餐");
    if($("rTagS").checked) tags.push("加餐");
    if(!tags.length){ alert("至少勾选一个类型"); return; }
    const budget = $("rBudget").value || "低";
    const ingText = $("rIng").value || "";
    const rec = customToRecipe(name,tags,budget,ingText);

    state.customRecipes = Array.isArray(state.customRecipes)?state.customRecipes:[];
    const exists = state.customRecipes.some(r=>r.name===name);
    if(exists){ alert("已存在同名食谱，请换个名字"); return; }
    state.customRecipes.push(rec);
    saveState();
    $("rName").value = ""; $("rIng").value = "";
    $("rTagB").checked=false; $("rTagL").checked=false; $("rTagD").checked=false; $("rTagS").checked=false;
    renderRecipes();
    renderRecipeManager();
    renderDays();
    alert("已添加！");
  });

  clearBtn.addEventListener("click", ()=>{
    if(confirm("确定清空所有自定义食谱？")){
      state.customRecipes = [];
      saveState();
      renderRecipes();
      renderRecipeManager();
      renderDays();
    }
  });
}

function genShoppingList(){
  if(!state.startDate){ alert("先设置开始日期并生成28天"); return; }
  const fromKey = $("shopStart").value;
  const daysN = parseInt($("shopDays").value,10);
  if(!fromKey){ alert("请选择起始日期"); return; }

  const fromDate = keyToDate(fromKey);
  const start = keyToDate(state.startDate);
  const idx = Math.round((fromDate - start)/(24*3600*1000));
  if(idx<0||idx>27){ alert("起始日期不在28天周期内"); return; }

  const sum = {};
  const customOthers = {};
  for(let i=0;i<daysN;i++){
    const k = dateToKey(addDays(fromDate,i));
    const d = state.days[k];
    if(!d) continue;
    [d.meals.breakfast,d.meals.lunch,d.meals.snack,d.meals.dinner].forEach(name=>{
      const r = recipeByName(name); if(!r) return;
      r.ingredients.forEach(([ingKey,amt])=>addToMap(sum, ingKey, amt));
      if(Array.isArray(r.others) && r.others.length){
        for(const o of r.others){
          const key = `${o.name}`;
          const amt = (o.amount==null)?0:o.amount;
          customOthers[key] = customOthers[key] || {amount:0, unit:o.unit||""};
          customOthers[key].amount += amt;
          if(!customOthers[key].unit && o.unit) customOthers[key].unit = o.unit;
        }
      }
    });

    // 补蔬菜到800g（按当天菜单粗补）
    const dayVeg =
      (recipeByName(d.meals.lunch)?.ingredients?.find(x=>x[0]==="veg_mix")?.[1]||0) +
      (recipeByName(d.meals.dinner)?.ingredients?.find(x=>x[0]==="veg_mix")?.[1]||0);
    if(dayVeg < 800) addToMap(sum,"veg_mix",800-dayVeg);
  }

  const order = ["chicken","egg","tofu","tofu_dry","shrimp","tuna","yogurt","milk","oats","broccoli","veg_mix","tomato","mushroom","cucumber","banana","apple","oil","soy_sauce","garlic"];
  const keys = Object.keys(sum).sort((a,b)=>order.indexOf(a)-order.indexOf(b));
  const lines = [];
  lines.push(`购物清单（${fromKey} 起，${daysN}天）`);
  lines.push(`——————————————`);

  keys.forEach(k=>{
    const meta = ING[k] || {label:k, unit:""};
    const val = sum[k]; if(!val) return;
    lines.push(`- ${meta.label}：${formatAmount(k,val)} ${meta.unit}`.trim());
  });
  lines.push(`——————————————`);
  const otherKeys = Object.keys(customOthers);
  if(otherKeys.length){
    lines.push('其他（自定义食材）');
    for(const k of otherKeys){
      const it = customOthers[k];
      const amtText = it.amount ? (Math.round(it.amount*10)/10) : '';
      const unitText = it.unit || '';
      lines.push(`- ${k} ${amtText}${unitText}`.trim());
    }
    lines.push('——————————————');
  }

  lines.push(`Safari 提示：复制按钮若失败，手动全选复制即可。`);
  $("shopOut").value = lines.join("\n");
}

async function copyShopping(){
  const txt = $("shopOut").value || "";
  if(!txt){ alert("先生成清单"); return; }
  try{
    await navigator.clipboard.writeText(txt);
    alert("已复制到剪贴板！");
  }catch(e){
    alert("Safari 可能限制自动复制：请手动全选文本复制。");
  }
}

/** 体重/腰围趋势 */
function saveBodyLog(){
  const k = $("bwDate").value;
  if(!k){ alert("先选日期"); return; }
  const w = parseFloat($("bwWeight").value);
  const wa = parseFloat($("bwWaist").value);
  if(isNaN(w) && isNaN(wa)){ alert("至少填体重或腰围"); return; }
  state.body.logs[k] = { weight: isNaN(w)?null:w, waist: isNaN(wa)?null:wa };
  saveState(); renderBodyCharts(); alert("已保存！");
}
function clearBodyLogs(){
  if(confirm("确定清空所有体重/腰围记录？")){
    state.body.logs = {};
    saveState(); renderBodyCharts();
  }
}
function getSortedBodyPoints(field){
  const keys = Object.keys(state.body.logs).sort();
  return keys.map(k=>({x:k, y: state.body.logs[k][field]})).filter(p=>p.y!=null && !isNaN(p.y));
}
function drawLineChart(canvas, points, title){
  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = "rgba(255,255,255,0.02)";
  ctx.fillRect(0,0,W,H);
  const pad = 42;
  if(points.length < 2){
    ctx.fillStyle = "rgba(255,255,255,0.75)";
    ctx.font = "14px system-ui";
    ctx.fillText(title + "（数据不足）", pad, 30);
    return;
  }
  const ys = points.map(p=>p.y);
  let minY = Math.min(...ys), maxY = Math.max(...ys);
  if(minY === maxY){ minY -= 1; maxY += 1; }

  ctx.strokeStyle = "rgba(255,255,255,0.08)";
  ctx.lineWidth = 1;
  for(let i=0;i<=4;i++){
    const y = pad + (H-2*pad)*(i/4);
    ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-pad,y); ctx.stroke();
  }

  ctx.fillStyle = "rgba(255,255,255,0.75)";
  ctx.font = "14px system-ui";
  ctx.fillText(title, pad, 26);
  ctx.fillStyle = "rgba(155,176,200,0.95)";
  ctx.font = "12px system-ui";
  ctx.fillText(maxY.toFixed(1), 8, pad+4);
  ctx.fillText(minY.toFixed(1), 8, H-pad+4);

  const N = points.length;
  const xStep = (W - 2*pad) / (N - 1);
  const mapY = (y)=> pad + (H-2*pad) * (1 - (y-minY)/(maxY-minY));

  ctx.strokeStyle = "rgba(78,161,255,0.95)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  for(let i=0;i<N;i++){
    const x = pad + xStep*i;
    const y = mapY(points[i].y);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();

  ctx.fillStyle = "rgba(33,196,123,0.95)";
  for(let i=0;i<N;i++){
    const x = pad + xStep*i;
    const y = mapY(points[i].y);
    ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
  }
}

function renderBodyCharts(){
  const wPts = getSortedBodyPoints("weight");
  const waPts = getSortedBodyPoints("waist");
  drawLineChart($("chartWeight"), wPts, "体重(kg)");
  drawLineChart($("chartWaist"), waPts, "腰围(cm)");

  const stats = [];
  if(wPts.length>=2){
    const delta = wPts[wPts.length-1].y - wPts[0].y;
    stats.push(`体重变化：${delta.toFixed(1)} kg`);
  }
  if(waPts.length>=2){
    const delta = waPts[waPts.length-1].y - waPts[0].y;
    stats.push(`腰围变化：${delta.toFixed(1)} cm`);
  }
  $("bwStats").innerHTML = stats.length ? stats.join("｜") : "还没有足够数据形成趋势。";
}

/** 导出/导入/重置 */

function exportCSV(){
  if(!state.startDate){ alert("先设置开始日期并生成28天"); return; }
  const start = keyToDate(state.startDate);
  const rows = [];
  rows.push(["date","dow","plan","done","kcalOk","proteinOk","vegOk","waterOk","stepsOk","sleepOk","noSugarDrink","breakfast","lunch","snack","dinner","notes"].join(","));
  for(let i=0;i<28;i++){
    const day = addDays(start,i);
    const key = dateToKey(day);
    const d = state.days[key];
    if(!d) continue;
    const vals = [
      key,
      "周"+DOW[day.getDay()],
      TRAIN_PLAN.find(x=>x.code===d.planCode)?.name || d.planCode,
      d.done?1:0,
      d.tasks.kcalOk?1:0,
      d.tasks.proteinOk?1:0,
      d.tasks.vegOk?1:0,
      d.tasks.waterOk?1:0,
      d.tasks.stepsOk?1:0,
      d.tasks.sleepOk?1:0,
      d.tasks.noSugarDrink?1:0,
      d.meals.breakfast,
      d.meals.lunch,
      d.meals.snack,
      d.meals.dinner,
      (d.notes||"")
    ];
    rows.push(vals.map(v=>{
      const s = String(v??"");
      return /[",\n]/.test(s) ? `"${s.replaceAll('"','""')}"` : s;
    }).join(","));
  }
  rows.push("");
  rows.push("body_logs");
  rows.push(["date","weight","waist"].join(","));
  const bkeys = Object.keys(state.body.logs||{}).sort();
  for(const k of bkeys){
    const it = state.body.logs[k];
    rows.push([k, it.weight??"", it.waist??""].join(","));
  }

  const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "减脂打卡_导出.csv";
  a.click();
  URL.revokeObjectURL(a.href);
}

function exportJSON(){
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "减脂打卡_备份.json";
  a.click();
  URL.revokeObjectURL(a.href);
}
async function importJSON(file){
  const txt = await file.text();
  const obj = JSON.parse(txt);
  state = Object.assign(defaultState(), obj);
  saveState();
  bindControls();
bindBottomBar();
  bindRecipeManager();
  renderAll();
  alert("导入成功！");
}
function resetAll(){
  if(confirm("确定清空本机所有数据？不可恢复（除非你有JSON备份）")){
    state = defaultState();
    saveState();
    bindControls();
    renderAll();
  }
}

/** 导航 */
const TABS = [
  { id:"dashboard", label:"总览" },
  { id:"calendar", label:"日历" },
  { id:"daily", label:"每日打卡" },
  { id:"training", label:"训练" },
  { id:"food", label:"食谱&购物清单" },
];
function renderNav(){
  $("nav").innerHTML = TABS.map(t=>`<button class="tab" data-tab="${t.id}">${t.label}</button>`).join("");
  document.querySelectorAll(".tab").forEach(btn=>{
    btn.addEventListener("click", ()=>setTab(btn.getAttribute("data-tab")));
  });
}
function setTab(id){
  state._ui = state._ui || {};
  state._ui.tab = id;
  // 不频繁写入：仅记录当前页
  saveState();
  document.querySelectorAll(".tab").forEach(b=>b.classList.toggle("active", b.getAttribute("data-tab")===id));
  document.querySelectorAll(".panel").forEach(p=>p.style.display="none");
  $(`panel-${id}`).style.display = "block";
}

/** 绑定控件 & 主渲染 */
function bindControls(){
  $("startDate").value = state.startDate || "";
  $("trainKcal").value = state.trainKcal;
  $("restKcal").value = state.restKcal;
  $("protein").value = state.protein;

  $("startDate").addEventListener("change", ()=>{ state.startDate = $("startDate").value; saveState(); renderAll(); });
  $("trainKcal").addEventListener("change", ()=>{ state.trainKcal = Number($("trainKcal").value||2400); saveState(); renderAll(); });
  $("restKcal").addEventListener("change", ()=>{ state.restKcal = Number($("restKcal").value||2200); saveState(); renderAll(); });
  $("protein").addEventListener("change", ()=>{ state.protein = Number($("protein").value||180); saveState(); renderAll(); });

  $("regen").addEventListener("click", ()=>{ if(!state.startDate){ alert("请先选择开始日期（建议周一）。"); return; } ensureDays(); renderAll(); });

  $("exportBtn").addEventListener("click", exportJSON);
  $("exportCSV").addEventListener("click", exportCSV);
  $("importFile").addEventListener("change", async (e)=>{
    const file=e.target.files?.[0]; if(!file) return;
    try{ await importJSON(file); } catch(err){ alert("导入失败：JSON格式不正确"); } finally{ e.target.value=""; }
  });
  $("resetBtn").addEventListener("click", resetAll);

  $("exportICS").addEventListener("click", exportICS);

  $("bwDate").value = dateToKey(new Date());
  $("bwSave").addEventListener("click", saveBodyLog);
  $("bwClear").addEventListener("click", clearBodyLogs);

  $("logDate").value = dateToKey(new Date());
  renderLogPlanOptions();
  $("loadLog").addEventListener("click", loadLog);
  $("saveLog").addEventListener("click", saveLog);

  renderLiftControls();
  $("refreshLift").addEventListener("click", renderLiftChart);
  $("liftEx1").addEventListener("change", renderLiftChart);
  $("liftEx2").addEventListener("change", renderLiftChart);
  $("liftEx3").addEventListener("change", renderLiftChart);
  $("liftMetric").addEventListener("change", renderLiftChart);
  $("liftRange").addEventListener("change", renderLiftChart);

  $("genShop").addEventListener("click", genShoppingList);
  $("copyShop").addEventListener("click", copyShopping);
}


/** 日历视图 */
function renderCalendar(){
  const grid = $("calGrid");
  const header = $("calHeader");
  const weekHead = $("calWeekHead");
  if(!grid || !header) return;

  if(!state.startDate){
    if(weekHead){ weekHead.innerHTML = ["日","一","二","三","四","五","六"].map(x=>`<div>周${x}</div>`).join(""); }
  header.innerHTML = `<span class="muted">请先在「总览」设置开始日期并生成28天。</span>`;
    if(weekHead) weekHead.innerHTML = "";
    grid.innerHTML = "";
    return;
  }
  ensureDays();
  const start = keyToDate(state.startDate);
  const keys = Array.from({length:28},(_,i)=>dateToKey(addDays(start,i)));
  const startDow = keyToDate(keys[0]).getDay();
  const todayKey = dateToKey(new Date());

  const doneCount = keys.filter(k=>!!state.days[k]?.done).length;
  const doneRate = Math.round(doneCount/28*100);

  const TASK_KEYS = ["kcalOk","proteinOk","vegOk","waterOk","stepsOk","sleepOk","noSugarDrink"];
  const totalTaskSlots = 28 * TASK_KEYS.length;
  const doneTaskSlots = keys.reduce((acc,k)=>{
    const t = state.days[k]?.tasks || {};
    return acc + TASK_KEYS.reduce((a,kk)=>a+(t[kk]?1:0),0);
  },0);
  const taskRate = totalTaskSlots ? Math.round(doneTaskSlots/totalTaskSlots*100) : 0;

  header.innerHTML = `
    <span class="pill"><span class="muted">周期</span> <strong>${keys[0]}</strong> <span class="muted">→</span> <strong>${keys[27]}</strong></span>
    <span class="pill"><span class="muted">完成率</span> <strong>${doneRate}%</strong> <span class="muted">（${doneCount}/28）</span></span>
    <span class="pill"><span class="muted">任务完成</span> <strong>${taskRate}%</strong></span>
    <span class="pill"><span class="muted">今天</span> <strong>${todayKey}</strong></span>
  `;

  // Fill leading blanks
  const cells = [];
  for(let i=0;i<startDow;i++){
    cells.push(`<div></div>`);
  }

  const nowKey = dateToKey(new Date());
  keys.forEach(k=>{
    const d = state.days[k];
    const dt = keyToDate(k);
    const isPast = dt < keyToDate(nowKey);

    const t = d?.tasks || {};
    const taskDone = TASK_KEYS.reduce((a,kk)=>a+(t[kk]?1:0),0);
    const taskPct = Math.round(taskDone/TASK_KEYS.length*100);

    let cls = "calCell";
    let badge = `<span class="calBadge calTodo">未完成</span>`;
    if(d?.done){ cls += " calDone"; badge = `<span class="calBadge calDone">已完成</span>`; }
    else if(isPast){ cls += " calMiss"; badge = `<span class="calBadge calMiss">过期</span>`; }
    if(k===todayKey) cls += " calToday";

    const planName = TRAIN_PLAN.find(x=>x.code===d.planCode)?.name || d.planCode;
    cells.push(`
      <div class="${cls}" data-cal="${k}">
        <div class="calTop">
          <div class="calDate">${k.slice(5)}</div>
          <div class="calDow">周${DOW[dt.getDay()]}</div>
        </div>
        <div class="small">${escapeHtml(planName)}</div>
        <div class="taskTiny"><div style="width:${taskPct}%;"></div></div>
        <div class="row" style="justify-content:space-between; gap:8px;">
          ${badge}
          <span class="calBadge" style="opacity:.85;">任务 ${taskDone}/${TASK_KEYS.length}（${taskPct}%）</span>
        </div>
      </div>
    `);
  });

  grid.innerHTML = cells.join("");
  document.querySelectorAll("[data-cal]").forEach(el=>{
    el.addEventListener("click", ()=>{
      const k = el.getAttribute("data-cal");
      setTab("daily");
      setTimeout(()=>{
        const row = document.querySelector(`#dayrow-${CSS.escape(k)}`);
        if(row) row.scrollIntoView({behavior:"smooth", block:"start"});
      }, 60);
    });
  });
}


/** 生成 iPhone 日历提醒 (.ics) */
function pad2(n){ return String(n).padStart(2,"0"); }
function toICSDate(dt){
  // local time -> YYYYMMDDTHHMMSS
  return dt.getFullYear()+pad2(dt.getMonth()+1)+pad2(dt.getDate())+"T"+pad2(dt.getHours())+pad2(dt.getMinutes())+"00";
}
function exportICS(){
  if(!state.startDate){ alert("先设置开始日期并生成28天"); return; }
  const t = $("icsTime")?.value || "20:30";
  const [hh,mm] = t.split(":").map(Number);
  const start = keyToDate(state.startDate);
  const lines = [];
  lines.push("BEGIN:VCALENDAR");
  lines.push("VERSION:2.0");
  lines.push("PRODID:-//Cut4W//CN");
  lines.push("CALSCALE:GREGORIAN");
  lines.push("METHOD:PUBLISH");

  for(let i=0;i<28;i++){
    const day = addDays(start,i);
    const s = new Date(day.getFullYear(), day.getMonth(), day.getDate(), hh, mm, 0);
    const e = new Date(day.getFullYear(), day.getMonth(), day.getDate(), hh, mm+10, 0);
    const uid = `cut4w-${dateToKey(day)}-${hh}${mm}@local`;
    lines.push("BEGIN:VEVENT");
    lines.push("UID:"+uid);
    lines.push("DTSTAMP:"+toICSDate(new Date()));
    lines.push("DTSTART:"+toICSDate(s));
    lines.push("DTEND:"+toICSDate(e));
    lines.push("SUMMARY:减脂打卡");
    lines.push("DESCRIPTION:打开打卡页面，完成训练/饮食勾选。");
    lines.push("BEGIN:VALARM");
    lines.push("TRIGGER:-PT10M");
    lines.push("ACTION:DISPLAY");
    lines.push("DESCRIPTION:减脂打卡提醒");
    lines.push("END:VALARM");
    lines.push("END:VEVENT");
  }

  lines.push("END:VCALENDAR");
  const blob = new Blob([lines.join("\r\n")], {type:"text/calendar;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "减脂打卡_28天提醒.ics";
  a.click();
  URL.revokeObjectURL(a.href);
}

/** 力量进步图（从训练日志提取） */
function getAllExercises(){
  const set = new Set();
  Object.values(WORKOUTS).forEach(w=>w.items.forEach(it=>set.add(it.ex)));
  return Array.from(set);
}
function renderLiftControls(){
  const s1 = $("liftEx1"), s2 = $("liftEx2"), s3 = $("liftEx3");
  if(!s1 || !s2 || !s3) return;
  const exs = getAllExercises();

  const opts1 = exs.map(x=>`<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join("");
  const optsN = `<option value="">（不选）</option>` + opts1;

  s1.innerHTML = opts1;
  s2.innerHTML = optsN;
  s3.innerHTML = optsN;

  state._ui = state._ui || {};
  if(state._ui.liftEx1 && exs.includes(state._ui.liftEx1)) s1.value = state._ui.liftEx1;
  if(state._ui.liftEx2 && exs.includes(state._ui.liftEx2)) s2.value = state._ui.liftEx2;
  if(state._ui.liftEx3 && exs.includes(state._ui.liftEx3)) s3.value = state._ui.liftEx3;
}
function getLiftSeries(exName, metric, rangeDays){
  const items = [];
  const logs = state.trainingLogs || {};
  let keys = Object.keys(logs).sort(); // date|plan
  if(rangeDays && rangeDays!=='all'){
    const nd = parseInt(rangeDays,10);
    if(!isNaN(nd)){
      const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-nd);
      keys = keys.filter(k=>{
        const dk = k.split('|')[0];
        const dt = keyToDate(dk);
        return dt >= cutoff;
      });
    }
  }
  for(const k of keys){
    const [dateKey] = k.split("|");
    const data = logs[k];
    const arr = data?.items?.[exName];
    if(!Array.isArray(arr)) continue;
    let maxW = null, bestE1 = null;
    for(const s of arr){
      const w = parseFloat(s.w);
      const r = parseFloat(s.r);
      if(!isNaN(w)){
        maxW = (maxW==null) ? w : Math.max(maxW, w);
        if(!isNaN(r) && r>0){
          const e1 = w * (1 + r/30); // Epley
          bestE1 = (bestE1==null) ? e1 : Math.max(bestE1, e1);
        }
      }
    }
    const y = metric==="e1rm" ? bestE1 : maxW;
    if(y!=null && !isNaN(y)){
      items.push({x:dateKey, y});
    }
  }
  return items;
}
function drawMultiLineChart(canvas, series, title){
  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = "rgba(255,255,255,0.02)";
  ctx.fillRect(0,0,W,H);
  const pad = 46;

  // collect dates
  const dateSet = new Set();
  series.forEach(s=>s.points.forEach(p=>dateSet.add(p.x)));
  const dates = Array.from(dateSet).sort();
  if(dates.length < 2){
    ctx.fillStyle = "rgba(255,255,255,0.75)";
    ctx.font = "14px system-ui";
    ctx.fillText(title + "（数据不足）", pad, 30);
    return;
  }
  const allY = [];
  series.forEach(s=>s.points.forEach(p=>allY.push(p.y)));
  let minY = Math.min(...allY), maxY = Math.max(...allY);
  if(minY === maxY){ minY -= 1; maxY += 1; }

  const mapX = (i)=> pad + (W-2*pad) * (i/(dates.length-1));
  const mapY = (y)=> (H-pad) - (H-2*pad) * ((y-minY)/(maxY-minY));

  // grid + axes
  ctx.strokeStyle = "rgba(255,255,255,0.10)";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(pad, pad);
  ctx.lineTo(pad, H-pad);
  ctx.lineTo(W-pad, H-pad);
  ctx.stroke();

  // y labels
  ctx.fillStyle = "rgba(255,255,255,0.65)";
  ctx.font = "12px system-ui";
  for(let i=0;i<=4;i++){
    const yv = minY + (maxY-minY)*(i/4);
    const yy = mapY(yv);
    ctx.strokeStyle = "rgba(255,255,255,0.06)";
    ctx.beginPath(); ctx.moveTo(pad, yy); ctx.lineTo(W-pad, yy); ctx.stroke();
    ctx.fillText(yv.toFixed(1), 8, yy+4);
  }

  // x labels (start/mid/end)
  const labelIdx = [0, Math.floor((dates.length-1)/2), dates.length-1].filter((v,i,a)=>a.indexOf(v)===i);
  labelIdx.forEach(i=>{
    const x = mapX(i);
    ctx.fillText(dates[i].slice(5), x-12, H-pad+18);
  });

  // title
  ctx.fillStyle = "rgba(255,255,255,0.85)";
  ctx.font = "14px system-ui";
  ctx.fillText(title, pad, 24);

  const colors = ["rgba(78,161,255,0.95)","rgba(33,196,123,0.95)","rgba(255,176,32,0.95)"];
  const fillDots = ["rgba(78,161,255,0.95)","rgba(33,196,123,0.95)","rgba(255,176,32,0.95)"];

  // legend
  ctx.font = "12px system-ui";
  series.forEach((s,idx)=>{
    const x = pad + idx*170;
    const y = 38;
    ctx.fillStyle = colors[idx%colors.length];
    ctx.fillRect(x, y-9, 14, 6);
    ctx.fillStyle = "rgba(255,255,255,0.75)";
    ctx.fillText(s.name, x+20, y-4);
  });

  series.forEach((s,idx)=>{
    const color = colors[idx%colors.length];
    const map = new Map(s.points.map(p=>[p.x,p.y]));
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.beginPath();
    let started = false;
    for(let i=0;i<dates.length;i++){
      const dk = dates[i];
      if(!map.has(dk)) continue;
      const x = mapX(i);
      const y = mapY(map.get(dk));
      if(!started){ ctx.moveTo(x,y); started = true; }
      else ctx.lineTo(x,y);
    }
    ctx.stroke();

    // dots
    ctx.fillStyle = fillDots[idx%fillDots.length];
    for(let i=0;i<dates.length;i++){
      const dk = dates[i];
      if(!map.has(dk)) continue;
      const x = mapX(i);
      const y = mapY(map.get(dk));
      ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
    }
  });
}
function renderLiftChart(){
  const metric = $("liftMetric")?.value || "maxw";
  const range = $("liftRange")?.value || "all";
  const ex1 = $("liftEx1")?.value;
  const ex2 = $("liftEx2")?.value;
  const ex3 = $("liftEx3")?.value;

  const exs = [ex1,ex2,ex3].filter(Boolean);
  if(!exs.length){ $("liftStats").innerHTML = "请选择至少一个动作。"; return; }

  state._ui = state._ui || {};
  state._ui.liftEx1 = ex1 || "";
  state._ui.liftEx2 = ex2 || "";
  state._ui.liftEx3 = ex3 || "";
  saveState();

  const series = exs.map(name=>({name, points:getLiftSeries(name, metric, range)})).filter(s=>s.points.length);
  drawMultiLineChart($("liftChart"), series, metric==="e1rm" ? "估算1RM 对比" : "最高重量(kg) 对比");

  const lines = [];
  series.forEach(s=>{
    if(s.points.length>=2){
      const d = s.points[s.points.length-1].y - s.points[0].y;
      lines.push(`${escapeHtml(s.name)}：${s.points[0].y.toFixed(1)} → ${s.points[s.points.length-1].y.toFixed(1)}（Δ${d.toFixed(1)}）`);
    }else{
      lines.push(`${escapeHtml(s.name)}：数据不足`);
    }
  });
  $("liftStats").innerHTML = lines.join("<br/>");
}

/** 外卖/食堂估算 */

const TAKEOUT_DB = {
  chicken:{kcalPer100:165, pPer100:31},
  beeflean:{kcalPer100:200, pPer100:26},
  fish:{kcalPer100:120, pPer100:24},
  porklean:{kcalPer100:185, pPer100:25},
  tofu:{kcalPer100:110, pPer100:12},
};
function calcTakeout(){
  const prot = $("toProt").value;
  const protG = parseFloat($("toProtG").value||0);
  const vegG = parseFloat($("toVegG").value||0);
  const carbBowl = parseFloat($("toCarb").value||0);
  const oilG = parseFloat($("toOil").value||0);
  const extra = parseFloat($("toExtra").value||0);

  const meta = TAKEOUT_DB[prot] || TAKEOUT_DB.chicken;
  const protK = (protG/100)*meta.kcalPer100;
  const protP = (protG/100)*meta.pPer100;

  // veg: 35 kcal/100g as rough
  const vegK = (vegG/100)*35;
  const vegP = (vegG/100)*2.0;

  // rice: 1 bowl cooked ~ 250g -> ~ 290 kcal, ~ 6g protein
  const riceK = carbBowl * 290;
  const riceP = carbBowl * 6;

  const oilK = oilG * 9; // 1g fat = 9 kcal
  const kcal = Math.round(protK + vegK + riceK + oilK + extra);
  const p = Math.round(protP + vegP + riceP);

  $("toKcal").textContent = kcal;
  $("toP").textContent = p;
  $("toHint").textContent = `组成：蛋白${protG}g + 蔬菜${vegG}g + 米饭${carbBowl}碗 + 油约${oilG}g + 额外${extra}kcal`;
  return {kcal, p, text:`外卖估算：${kcal}kcal，蛋白≈${p}g（蛋白${protG}g / 蔬菜${vegG}g / 米饭${carbBowl}碗 / 油${oilG}g / 额外${extra}kcal）`};
}
async function copyText(txt){
  try{ await navigator.clipboard.writeText(txt); alert("已复制！"); }
  catch(e){ alert("Safari 可能限制自动复制：请手动复制。"); }
}
function writeToTodayNote(txt){
  const todayKey = dateToKey(new Date());
  if(!state.days[todayKey]){ alert("今天不在28天周期内（或未生成）。"); return; }
  const prev = state.days[todayKey].notes || "";
  state.days[todayKey].notes = (prev ? (prev + " | ") : "") + txt;
  saveState();
  renderDays();
  renderTodayBox();
  alert("已写入今天备注！");
}

/** 7天菜单生成 */
function budgetOK(r, b){
  if(b==="all") return true;
  if(b==="低") return r.budget==="低";
  if(b==="中") return (r.budget==="低" || r.budget==="中");
  return true;
}
function proteinScore(r){
  // crude scoring based on known ingredients keys
  const ing = r.ingredients || [];
  const keys = ing.map(x=>x[0]);
  let s = 0;
  if(keys.includes("chicken")) s+=4;
  if(keys.includes("shrimp")) s+=3;
  if(keys.includes("tuna")) s+=3;
  if(keys.includes("egg")) s+=2;
  if(keys.includes("tofu")||keys.includes("tofu_dry")) s+=2;
  return s;
}
function pickRecipe(list, used, preferHigh, avoidRepeat){
  if(!list.length) return null;
  let candidates = list.slice();
  if(avoidRepeat){
    candidates = candidates.filter(r=>!used.has(r.name));
    if(!candidates.length) candidates = list.slice(); // fallback
  }
  if(preferHigh){
    candidates.sort((a,b)=>proteinScore(b)-proteinScore(a));
    // pick from top 30% with some randomness
    const topN = Math.max(1, Math.floor(candidates.length*0.3));
    return candidates[Math.floor(Math.random()*topN)];
  }
  return candidates[Math.floor(Math.random()*candidates.length)];
}
let _weekMenuDraft = null;
function renderWmStart(){
  const sel = $("wmStart");
  if(!sel) return;
  sel.innerHTML = "";
  if(!state.startDate){ sel.innerHTML = `<option value="">先设置开始日期</option>`; return; }
  const start = keyToDate(state.startDate);
  for(let i=0;i<28;i++){
    const key = dateToKey(addDays(start,i));
    sel.innerHTML += `<option value="${key}">${key}</option>`;
  }
  const todayKey = dateToKey(new Date());
  if(state.days[todayKey]) sel.value = todayKey;
}
function genWeekMenu(){
  if(!state.startDate){ alert("先设置开始日期并生成28天"); return; }
  ensureDays();
  const fromKey = $("wmStart").value;
  if(!fromKey){ alert("选择起始日期"); return; }
  const budget = $("wmBudget").value;
  const mode = $("wmMode")? $("wmMode").value : "all";
  const flavor = $("wmFlavor")? $("wmFlavor").value : "all";
  const prefer = $("wmProtein").value==="1";
  const avoid = $("wmVar").value==="1";

  const all = getAllRecipes().filter(r=>r && r.name).filter(r=>budgetOK(r,budget))
    .filter(r=>{
      const src = r.src || "家常";
      return mode==="all" ? true : (src===mode);
    })
    .filter(r=>{
      if(flavor==="all") return true;
      return (r.tags||[]).includes(flavor);
    });
  const B = all.filter(r=>r.tags?.includes("早餐") && budgetOK(r,budget));
  const L = all.filter(r=>r.tags?.includes("午餐") && budgetOK(r,budget));
  const D = all.filter(r=>r.tags?.includes("晚餐") && budgetOK(r,budget));
  const S = all.filter(r=>r.tags?.includes("加餐") && budgetOK(r,budget));

  const used = new Set();
  const out = [];
  const fromDate = keyToDate(fromKey);
  for(let i=0;i<7;i++){
    const k = dateToKey(addDays(fromDate,i));
    const b = pickRecipe(B, used, false, avoid);
    const l = pickRecipe(L, used, prefer, avoid);
    const s = pickRecipe(S, used, false, avoid);
    const d = pickRecipe(D, used, prefer, avoid);
    [b,l,s,d].forEach(x=>{ if(x) used.add(x.name); });
    out.push({date:k, breakfast:b?.name||"", lunch:l?.name||"", snack:s?.name||"", dinner:d?.name||""});
  }
  _weekMenuDraft = out;
  $("wmBody").innerHTML = out.map(r=>`
    <tr>
      <td>${r.date}</td>
      <td class="small">${escapeHtml(r.breakfast)}</td>
      <td class="small">${escapeHtml(r.lunch)}</td>
      <td class="small">${escapeHtml(r.snack)}</td>
      <td class="small">${escapeHtml(r.dinner)}</td>
    </tr>
  `).join("");
}
function applyWeekMenu(){
  if(!_weekMenuDraft || !_weekMenuDraft.length){ alert("先生成菜单"); return; }
  for(const r of _weekMenuDraft){
    if(!state.days[r.date]) continue;
    state.days[r.date].meals.breakfast = r.breakfast || state.days[r.date].meals.breakfast;
    state.days[r.date].meals.lunch = r.lunch || state.days[r.date].meals.lunch;
    state.days[r.date].meals.snack = r.snack || state.days[r.date].meals.snack;
    state.days[r.date].meals.dinner = r.dinner || state.days[r.date].meals.dinner;
  }
  saveState();
  renderDays();
  renderShopStart();
  alert("已应用到日程！");
}
async function copyWeekMenu(){
  if(!_weekMenuDraft || !_weekMenuDraft.length){ alert("先生成菜单"); return; }
  const lines = ["日期\t早餐\t午餐\t加餐\t晚餐"];
  for(const r of _weekMenuDraft){
    lines.push([r.date,r.breakfast,r.lunch,r.snack,r.dinner].join("\t"));
  }
  await copyText(lines.join("\n"));
}


function toast(msg){
  let el = document.getElementById("toast");
  if(!el){
    el = document.createElement("div");
    el.id = "toast";
    el.className = "toast";
    document.body.appendChild(el);
  }
  el.textContent = msg;
  el.classList.add("show");
  clearTimeout(el._t);
  el._t = setTimeout(()=>el.classList.remove("show"), 1800);
}

function getKeyFromParam(p){
  if(!p) return null;
  if(p==="today") return dateToKey(new Date());
  // accept YYYY-MM-DD
  if(/^\d{4}-\d{2}-\d{2}$/.test(p)) return p;
  return null;
}

/**
 * Quick actions via URL params (for iPhone Shortcuts / Apple Watch).
 * Examples:
 *  - ?quick=done&day=today
 *  - ?quick=task&task=waterOk&value=1&day=today
 *  - ?quick=task&task=stepsOk&toggle=1&day=2026-01-02
 *  - ?quick=note&text=外卖估算...&day=today
 */
function applyQuickActionFromURL(){
  const url = new URL(window.location.href);
  const quick = url.searchParams.get("quick");
  if(!quick) return false;

  // Ensure we have a plan generated
  if(!state.startDate){
    toast("未设置开始日期：先在总览生成28天");
    return false;
  }
  ensureDays();

  const dayParam = url.searchParams.get("day") || "today";
  const key = getKeyFromParam(dayParam);
  if(!key || !state.days[key]){
    toast("该日期不在28天周期内");
    return false;
  }
  const d = state.days[key];

  const TASK_KEYS = ["kcalOk","proteinOk","vegOk","waterOk","stepsOk","sleepOk","noSugarDrink"];

  if(quick==="done"){
    d.done = true;
    saveState();
    renderAll();
    setTab("daily");
    setTimeout(()=>{
      const row = document.querySelector(`#dayrow-${CSS.escape(key)}`);
      if(row) row.scrollIntoView({behavior:"smooth", block:"start"});
    }, 60);
    toast(`已标记完成：${key}`);
  }else if(quick==="task"){
    const task = url.searchParams.get("task");
    if(!TASK_KEYS.includes(task)){
      toast("未知任务项");
      return false;
    }
    const toggle = url.searchParams.get("toggle")==="1";
    const hasValue = url.searchParams.has("value");
    if(toggle){
      d.tasks[task] = !d.tasks[task];
    }else if(hasValue){
      d.tasks[task] = url.searchParams.get("value")==="1";
    }else{
      d.tasks[task] = true;
    }
    saveState();
    renderAll();
    setTab("daily");
    setTimeout(()=>{
      const row = document.querySelector(`#dayrow-${CSS.escape(key)}`);
      if(row) row.scrollIntoView({behavior:"smooth", block:"start"});
    }, 60);
    toast(`已更新：${key} · ${task}`);
  }else if(quick==="note"){
    const text = url.searchParams.get("text") || "";
    if(!text.trim()){ toast("备注为空"); return false; }
    d.notes = (d.notes ? (d.notes + " | ") : "") + text.trim();
    saveState();
    renderAll();
    setTab("daily");
    setTimeout(()=>{
      const row = document.querySelector(`#dayrow-${CSS.escape(key)}`);
      if(row) row.scrollIntoView({behavior:"smooth", block:"start"});
    }, 60);
    toast(`已写入备注：${key}`);
  }else{
    toast("未知 quick 指令");
    return false;
  }

  // Clean URL to avoid re-trigger on refresh
  url.search = "";
  window.history.replaceState({}, "", url.toString());
  return true;
}

function renderAll(){
  renderKPIs();
  renderWeekly();
  renderDays();
  renderTrainingPlan();
  renderRecipes();
  renderShopStart();
  renderBodyCharts();
  renderTodayBox();
  renderCalendar();
  renderWmStart();
}


function highlightTodayRow(){
  const key = dateToKey(new Date());
  document.querySelectorAll("tr.todayRow").forEach(tr=>tr.classList.remove("todayRow"));
  const row = document.querySelector(`#dayrow-${CSS.escape(key)}`);
  if(row) row.classList.add("todayRow");

function renderTodayBoard(){
  const el = document.getElementById("todayBoard");
  if(!el) return;
  const sub = document.getElementById("tbSub");
  const pills = document.getElementById("tbPills");
  const prog = document.getElementById("tbProg");
  const planPill = document.getElementById("tbPlanPill");
  const planDetail = document.getElementById("tbPlanDetail");
  const tasks = document.getElementById("tbTasks");
  const meals = document.getElementById("tbMeals");

  const todayKey = dateToKey(new Date());

  if(!state.startDate){
    sub.textContent = "先在「总览」设置开始日期并生成28天";
    pills.innerHTML = "";
    prog.style.width = "0%";
    planPill.innerHTML = `<span class="muted">—</span>`;
    planDetail.textContent = "—";
    tasks.innerHTML = `<div class="muted small">未生成周期</div>`;
    meals.textContent = "—";
    return;
  }

  ensureDays();
  const d = state.days[todayKey];
  if(!d){
    sub.textContent = `今天（${todayKey}）不在28天周期内`;
    pills.innerHTML = "";
    prog.style.width = "0%";
    planPill.innerHTML = `<span class="muted">—</span>`;
    planDetail.textContent = "—";
    tasks.innerHTML = `<div class="muted small">不在周期内</div>`;
    meals.textContent = "—";
    return;
  }

  const dt = keyToDate(todayKey);
  sub.textContent = `${todayKey} · 周${DOW[dt.getDay()]} · 本地保存`;

  // plan
  const planName = TRAIN_PLAN.find(x=>x.code===d.planCode)?.name || d.planCode;
  planPill.innerHTML = `<strong>${escapeHtml(planName)}</strong>`;

  // plan detail from WORKOUTS if exists
  const workout = WORKOUTS?.[d.planCode];
  if(workout?.items?.length){
    const lines = workout.items.slice(0,6).map(it=>`• ${it.ex}  ${it.sets}×${it.reps}${it.note?("（"+it.note+"）"):""}`);
    planDetail.innerHTML = lines.join("<br/>") + (workout.items.length>6 ? "<br/>…" : "");
  }else{
    planDetail.textContent = "打开「训练」页查看详细动作。";
  }

  const TASK_KEYS = [
    ["kcalOk","热量"],
    ["proteinOk","蛋白"],
    ["vegOk","蔬菜"],
    ["waterOk","喝水"],
    ["stepsOk","步数"],
    ["sleepOk","睡眠"],
    ["noSugarDrink","无糖"]
  ];
  const doneTasks = TASK_KEYS.reduce((a,[k])=>a+(d.tasks?.[k]?1:0),0);
  const taskPct = Math.round(doneTasks/TASK_KEYS.length*100);
  prog.style.width = `${taskPct}%`;

  pills.innerHTML = `
    <span class="tbPill"><span class="muted">任务</span> <strong>${doneTasks}/${TASK_KEYS.length}</strong></span>
    <span class="tbPill"><span class="muted">完成率</span> <strong>${taskPct}%</strong></span>
    <span class="tbPill"><span class="muted">训练</span> <strong>${d.done? "✅" : "—"}</strong></span>
  `;

  tasks.innerHTML = TASK_KEYS.map(([k,label])=>{
    const on = !!d.tasks?.[k];
    return `<div class="tbMiniBtn ${on?'on':''}" data-tbt="${k}">${label}</div>`;
  }).join("");

  meals.innerHTML = `早餐：${escapeHtml(d.meals?.breakfast||"—")}<br/>午餐：${escapeHtml(d.meals?.lunch||"—")}<br/>加餐：${escapeHtml(d.meals?.snack||"—")}<br/>晚餐：${escapeHtml(d.meals?.dinner||"—")}`;

  // bind buttons (idempotent)
  el.querySelectorAll("[data-tb]").forEach(btn=>{
    if(btn._bound) return;
    btn._bound = true;
    btn.addEventListener("click", ()=>{
      const act = btn.getAttribute("data-tb");
      if(act==="jump"){
        setTab("daily");
        setTimeout(()=>{
          highlightTodayRow();
          const row = document.querySelector(`#dayrow-${CSS.escape(todayKey)}`);
          if(row) row.scrollIntoView({behavior:"smooth", block:"start"});
        }, 80);
        toast("已跳到今天");
      }else if(act==="done"){
        d.done = !d.done;
        saveState();
        renderAll();
        toast(d.done ? "已标记：训练完成✅" : "已取消：训练完成");
      }
    });
  });

  el.querySelectorAll("[data-tbt]").forEach(btn=>{
    if(btn._bound) return;
    btn._bound = true;
    btn.addEventListener("click", ()=>{
      const k = btn.getAttribute("data-tbt");
      d.tasks[k] = !d.tasks[k];
      saveState();
      renderAll();
      toast(d.tasks[k] ? `已完成：${k}` : `已取消：${k}`);
    });
  });

  const toFood = document.getElementById("tbToFood");
  if(toFood && !toFood._bound){
    toFood._bound = true;
    toFood.addEventListener("click", ()=>{ setTab("food"); updateBottomBar();
  renderTodayBoard(); });
  }
}

}

function bindBottomBar(){
  const bar = document.getElementById("bottomBar");
  if(!bar) return;

  // tab buttons
  bar.querySelectorAll("[data-bbtab]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-bbtab");
      setTab(id);
      updateBottomBar();
      if(id==="daily"){ setTimeout(highlightTodayRow, 50); }
    });
  });

  // quick buttons
  bar.querySelectorAll("[data-bbquick]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const q = btn.getAttribute("data-bbquick");
      const key = dateToKey(new Date());
      if(!state.startDate){ toast("先在总览设置开始日期并生成28天"); return; }
      ensureDays();
      if(!state.days[key]){ toast("今天不在28天周期内"); return; }
      const d = state.days[key];

      if(q==="today"){
        setTab("daily");
        setTimeout(()=>{
          highlightTodayRow();
          const row = document.querySelector(`#dayrow-${CSS.escape(key)}`);
          if(row) row.scrollIntoView({behavior:"smooth", block:"start"});
        }, 80);
        toast("已跳到今天");
        return;
      }

      if(q==="done"){
        d.done = !d.done;
        saveState();
        renderAll();
        setTab("daily");
        setTimeout(()=>{
          highlightTodayRow();
          const row = document.querySelector(`#dayrow-${CSS.escape(key)}`);
          if(row) row.scrollIntoView({behavior:"smooth", block:"start"});
        }, 80);
        toast(d.done ? "已标记：今天完成✅" : "已取消：今天完成");
        return;
      }

      // tasks toggle
      d.tasks = d.tasks || {};
      d.tasks[q] = !d.tasks[q];
      saveState();
      renderAll();
      toast(`${d.tasks[q] ? "已完成" : "已取消"}：${q}`);
    });
  });
}

function updateBottomBar(){
  const bar = document.getElementById("bottomBar");
  if(!bar) return;

  // active tab
  bar.querySelectorAll("[data-bbtab]").forEach(btn=>btn.classList.remove("active"));
  const active = bar.querySelector(`[data-bbtab="${state._ui?.tab || "dashboard"}"]`);
  if(active) active.classList.add("active");

  // today's status
  const key = dateToKey(new Date());
  if(state.startDate){ ensureDays(); }
  const d = state.days?.[key];
  const doneBtn = bar.querySelector('[data-bbquick="done"]');
  if(doneBtn){
    doneBtn.classList.toggle("on", !!d?.done);
  }
  ["waterOk","stepsOk","proteinOk"].forEach(k=>{
    const b = bar.querySelector(`[data-bbquick="${k}"]`);
    if(!b) return;
    const on = !!d?.tasks?.[k];
    b.classList.toggle("on", on);
  });
}

/** 初始化 */
renderNav();
bindControls();
renderAll();
setTab("dashboard");
</script>


<div id="bottomBar" class="bottomBar" aria-label="快捷操作栏">
  <div class="bbRow">
    <div class="bbNav">
      <div class="bbBtn" data-bbtab="dashboard"><span class="bbIcon">🏠</span><span class="bbLabel">总览</span></div>
      <div class="bbBtn" data-bbtab="calendar"><span class="bbIcon">📅</span><span class="bbLabel">日历</span></div>
      <div class="bbBtn" data-bbtab="daily"><span class="bbIcon">✅</span><span class="bbLabel">打卡</span></div>
      <div class="bbBtn" data-bbtab="training"><span class="bbIcon">🏋️</span><span class="bbLabel">训练</span></div>
      <div class="bbBtn" data-bbtab="food"><span class="bbIcon">🍚</span><span class="bbLabel">饮食</span></div>
    </div>
    <div class="bbQuick">
      <div class="bbBtn ok" data-bbquick="done"><span class="bbIcon">⭐️</span><span class="bbLabel">完成</span></div>
      <div class="bbBtn" data-bbquick="waterOk"><span class="bbIcon">💧</span><span class="bbLabel">喝水</span></div>
      <div class="bbBtn" data-bbquick="stepsOk"><span class="bbIcon">👟</span><span class="bbLabel">步数</span></div>
      <div class="bbBtn" data-bbquick="proteinOk"><span class="bbIcon">🥩</span><span class="bbLabel">蛋白</span></div>
      <div class="bbBtn warnOn" data-bbquick="today"><span class="bbIcon">🎯</span><span class="bbLabel">今天</span></div>
    </div>
  </div>
</div>

</div>

</body>
</html>
